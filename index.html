<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RIA Intelligence</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0e0f11;--surface:#16181c;--surface2:#1e2128;--surface3:#252830;
  --border:#2c3038;--border2:#363b44;--text:#f0f1f3;--text2:#9aa0ad;--text3:#5c6270;
  --accent:#c8a96e;--accent2:#b8955a;--green:#4ade80;--green-dim:#1a3326;
  --red:#f87171;--red-dim:#2d1515;--blue:#60a5fa;--blue-dim:#1a2540;
  --purple:#a78bfa;--purple-dim:#1e1a35;--amber:#fbbf24;--amber-dim:#2a1f06;
}
html,body{height:100%;font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);font-size:14px;line-height:1.5;-webkit-font-smoothing:antialiased}
::-webkit-scrollbar{width:5px;height:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border2);border-radius:10px}
.serif{font-family:'Instrument Serif',serif}.mono{font-family:'DM Mono',monospace;font-size:12px}
input,select,textarea{font-family:'DM Sans',sans-serif;font-size:13px;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:9px 13px;border-radius:8px;outline:none;transition:border-color .2s,box-shadow .2s;width:100%}
input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(200,169,110,.12)}
select option{background:var(--surface2)}
button{font-family:'DM Sans',sans-serif;cursor:pointer;border:none;border-radius:8px;padding:9px 18px;font-size:13px;font-weight:500;transition:all .18s}
.btn-gold{background:var(--accent);color:#0e0f11;font-weight:600}.btn-gold:hover{background:var(--accent2);transform:translateY(-1px);box-shadow:0 4px 16px rgba(200,169,110,.3)}
.btn-ghost{background:transparent;color:var(--text2);border:1px solid var(--border)}.btn-ghost:hover{background:var(--surface2);color:var(--text);border-color:var(--border2)}
.btn-sm{padding:6px 12px;font-size:12px;border-radius:6px}.btn-icon{padding:7px 10px;font-size:14px}
.btn-danger{background:transparent;color:var(--red);border:1px solid rgba(248,113,113,.3)}.btn-danger:hover{background:var(--red-dim)}
.tag{display:inline-flex;align-items:center;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:500}
.tag-state{background:var(--blue-dim);color:var(--blue)}.tag-green{background:var(--green-dim);color:var(--green)}.tag-gold{background:rgba(200,169,110,.15);color:var(--accent)}.tag-dim{background:var(--surface3);color:var(--text2)}.tag-purple{background:var(--purple-dim);color:var(--purple)}.tag-red{background:var(--red-dim);color:var(--red)}.tag-amber{background:var(--amber-dim);color:var(--amber)}
.card{background:var(--surface);border:1px solid var(--border);border-radius:14px;overflow:hidden}
table{width:100%;border-collapse:collapse}
th{text-align:left;padding:11px 14px;font-size:11px;text-transform:uppercase;letter-spacing:.06em;color:var(--text3);border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--surface);z-index:2;white-space:nowrap;cursor:pointer;user-select:none;font-weight:500}
th:hover{color:var(--text2)}td{padding:11px 14px;font-size:13px;border-bottom:1px solid var(--border);white-space:nowrap}
tr:hover td{background:var(--surface2)}tr:last-child td{border-bottom:none}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:18px 20px}
.stat-label{font-size:10px;text-transform:uppercase;letter-spacing:.08em;color:var(--text3);font-weight:500}
.stat-value{font-family:'Instrument Serif',serif;font-size:28px;margin-top:4px;line-height:1.1}
.stat-sub{font-size:11px;color:var(--text3);margin-top:3px}
@keyframes fadeUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideDown{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}
.fade-up{animation:fadeUp .38s cubic-bezier(.22,.68,0,1.2) both}
.fade-in{animation:fadeIn .25s ease both}
.slide-down{animation:slideDown .3s ease both}
.detail-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(44,48,56,.6)}
.detail-row:last-child{border-bottom:none}.detail-label{font-size:12px;color:var(--text3)}.detail-value{font-family:'DM Mono',monospace;font-size:12px;color:var(--text)}
.section-head{font-size:10px;text-transform:uppercase;letter-spacing:.1em;color:var(--accent);font-weight:600;margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid var(--border)}
.highlight-row{background:rgba(74,222,128,.05)}
.rank-badge{width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;flex-shrink:0}
.pulse{width:7px;height:7px;border-radius:50%;background:var(--green);animation:pulse-anim 2s infinite}
@keyframes pulse-anim{0%,100%{box-shadow:0 0 0 0 rgba(74,222,128,.4)}50%{box-shadow:0 0 0 5px rgba(74,222,128,0)}}
.filter-group label{display:block;font-size:10px;text-transform:uppercase;letter-spacing:.07em;color:var(--text3);margin-bottom:5px;font-weight:500}
.filter-bar{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
.bar-fill{height:100%;border-radius:4px;transition:width .5s cubic-bezier(.22,.68,0,1.2)}
.saved-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:18px 20px;transition:border-color .2s}.saved-card:hover{border-color:var(--border2)}
.detail-panel{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:22px}
.metric-accent{color:var(--accent)}.metric-green{color:var(--green)}.metric-red{color:var(--red)}.metric-amber{color:var(--amber)}.metric-purple{color:var(--purple)}
.star-btn{background:none;border:none;cursor:pointer;font-size:17px;padding:3px 5px;transition:transform .15s,color .15s;border-radius:5px}
.star-btn:hover{transform:scale(1.2)}.star-btn.starred{color:#f59e0b}.star-btn:not(.starred){color:var(--text3)}.star-btn:not(.starred):hover{color:var(--accent)}
@keyframes copyFlash{0%{background:var(--green);color:#0e0f11}100%{background:var(--accent);color:#0e0f11}}
.copy-flash{animation:copyFlash .8s ease forwards}
.leaflet-container{background:#1a1c20!important;border-radius:10px}
.mp .leaflet-popup-content-wrapper{background:var(--surface);color:var(--text);border:1px solid var(--border2);border-radius:10px;box-shadow:0 12px 40px rgba(0,0,0,.6)}
.mp .leaflet-popup-tip{background:var(--surface)}
.mp .leaflet-popup-content{margin:14px;font-family:'DM Sans',sans-serif;font-size:12px;line-height:1.6}
.pvb{display:inline-block;margin-top:10px;padding:6px 14px;background:var(--accent);color:#0e0f11;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer}.pvb:hover{background:var(--accent2)}
.logo-mark{width:34px;height:34px;background:linear-gradient(135deg,var(--accent),#7c5c2e);border-radius:9px;display:flex;align-items:center;justify-content:center;font-family:'Instrument Serif',serif;font-size:16px;color:#0e0f11;flex-shrink:0}
.top-nav{background:rgba(14,15,17,.94);backdrop-filter:blur(16px);border-bottom:1px solid var(--border);padding:0 28px;display:flex;align-items:center;gap:28px;height:58px;flex-shrink:0;position:sticky;top:0;z-index:100}
.nav-brand{display:flex;align-items:center;gap:11px;margin-right:8px}
.nav-brand-name{font-family:'Instrument Serif',serif;font-size:19px;letter-spacing:-.02em}
.nav-link{font-size:13px;color:var(--text3);cursor:pointer;padding:4px 0;transition:color .15s;white-space:nowrap;position:relative}
.nav-link:hover{color:var(--text2)}.nav-link.active{color:var(--text)}
.nav-link.active::after{content:'';position:absolute;bottom:-3px;left:0;right:0;height:1px;background:var(--accent)}
.nav-link.locked{opacity:.4;cursor:not-allowed;pointer-events:none}
.nav-right{margin-left:auto;display:flex;align-items:center;gap:10px}
.page{padding:28px 28px 48px;max-width:1400px;margin:0 auto}
.page-title{font-family:'Instrument Serif',serif;font-size:30px;letter-spacing:-.02em;margin-bottom:4px}
.page-sub{font-size:12px;color:var(--text3)}
.table-scroll{overflow:auto;border-radius:14px}
.ss-row{cursor:pointer}.ss-row:hover td{background:rgba(200,169,110,.06)!important}
pre.prompt-box{white-space:pre-wrap;font-family:'DM Mono',monospace;font-size:12px;line-height:1.7;color:var(--text2);margin:0}
.score-meter{height:5px;border-radius:3px;background:var(--surface3);overflow:hidden;margin-top:5px}
.score-fill{height:100%;border-radius:3px;transition:width .6s cubic-bezier(.22,.68,0,1.2)}
.req{color:var(--red);margin-left:2px}
.form-field-label{display:block;font-size:11px;font-weight:500;color:var(--text3);margin-bottom:5px;text-transform:uppercase;letter-spacing:.06em}
.form-field-label.err{color:var(--red)}
.field-hint{font-size:11px;color:var(--text3);margin-top:4px}

/* Blur gate */
.blur-cell{filter:blur(5px);user-select:none;pointer-events:none}
.lock-overlay{position:relative}
.lock-overlay::after{content:'';position:absolute;inset:0;background:linear-gradient(to bottom,transparent 30%,rgba(14,15,17,.95) 100%);pointer-events:none;border-radius:14px}

/* Gate banner */
.gate-banner{background:linear-gradient(135deg,rgba(200,169,110,.12),rgba(200,169,110,.06));border:1px solid rgba(200,169,110,.3);border-radius:14px;padding:20px 24px;display:flex;align-items:center;gap:20px;margin-bottom:20px}
.gate-banner-icon{font-size:32px;flex-shrink:0}
.gate-banner-title{font-family:'Instrument Serif',serif;font-size:18px;margin-bottom:4px}
.gate-banner-sub{font-size:12px;color:var(--text3);line-height:1.6}

/* Onboarding modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(8px);z-index:200;display:flex;align-items:center;justify-content:center;padding:20px}
.modal{background:var(--surface);border:1px solid var(--border2);border-radius:18px;width:100%;max-width:640px;max-height:90vh;overflow-y:auto;box-shadow:0 24px 80px rgba(0,0,0,.7)}
.modal-header{padding:28px 28px 0}
.modal-body{padding:24px 28px 28px}
.modal-title{font-family:'Instrument Serif',serif;font-size:26px;letter-spacing:-.02em;margin-bottom:6px}
.modal-sub{font-size:13px;color:var(--text3);line-height:1.6;margin-bottom:20px}

/* Profile type selector */
.profile-type-card{border:2px solid var(--border);border-radius:12px;padding:18px 20px;cursor:pointer;transition:all .2s;flex:1}
.profile-type-card:hover{border-color:var(--border2)}
.profile-type-card.selected{border-color:var(--accent);background:rgba(200,169,110,.08)}
.profile-type-icon{font-size:24px;margin-bottom:10px}
.profile-type-title{font-size:14px;font-weight:600;margin-bottom:4px}
.profile-type-desc{font-size:12px;color:var(--text3);line-height:1.5}

/* Form grid */
.form-grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.form-grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
.form-section{margin-bottom:22px}
.form-section-title{font-size:10px;text-transform:uppercase;letter-spacing:.1em;color:var(--accent);font-weight:600;margin-bottom:12px;padding-bottom:6px;border-bottom:1px solid var(--border)}
.form-field{margin-bottom:0}

/* My Profile page */
.profile-page-header{background:linear-gradient(135deg,var(--surface),var(--surface2));border:1px solid var(--border);border-radius:16px;padding:28px;margin-bottom:20px;position:relative;overflow:hidden}
.profile-page-header::before{content:'';position:absolute;top:-40px;right:-40px;width:160px;height:160px;background:radial-gradient(circle,rgba(200,169,110,.12),transparent 70%);pointer-events:none}
.profile-avatar{width:52px;height:52px;border-radius:14px;background:linear-gradient(135deg,var(--accent),#7c5c2e);display:flex;align-items:center;justify-content:center;font-family:'Instrument Serif',serif;font-size:22px;color:#0e0f11;flex-shrink:0}

/* Steps indicator */
.steps{display:flex;gap:0;margin-bottom:24px}
.step{flex:1;display:flex;flex-direction:column;align-items:center;position:relative}
.step:not(:last-child)::after{content:'';position:absolute;top:14px;left:50%;width:100%;height:1px;background:var(--border);z-index:0}
.step-dot{width:28px;height:28px;border-radius:50%;border:2px solid var(--border);background:var(--surface2);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600;z-index:1;transition:all .2s;color:var(--text3)}
.step-dot.active{border-color:var(--accent);background:var(--accent);color:#0e0f11}
.step-dot.done{border-color:var(--green);background:var(--green-dim);color:var(--green)}
.step-label{font-size:10px;margin-top:6px;color:var(--text3);text-align:center}
.step.active .step-label{color:var(--accent)}

/* Role toggle */
.role-pill{display:flex;align-items:center;background:var(--surface2);border:1px solid var(--border);border-radius:20px;padding:3px;gap:2px}
.role-opt{padding:4px 12px;border-radius:16px;font-size:11px;cursor:pointer;transition:all .15s;color:var(--text3);font-weight:500}
.role-opt.active{background:var(--purple);color:#fff}
.role-opt.public-active{background:var(--blue);color:#fff}

/* Matched firms panel */
.match-card{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px 16px;transition:border-color .2s;cursor:pointer}
.match-card:hover{border-color:var(--border2)}
.match-score-pill{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600}

/* Tooltip */
.tt{position:relative;display:inline-block;cursor:help;border-bottom:1px dotted var(--text3)}
.tt-box{visibility:hidden;opacity:0;position:absolute;bottom:calc(100% + 8px);left:50%;transform:translateX(-50%);background:#1e2128;border:1px solid var(--border2);border-radius:9px;padding:9px 13px;font-size:11px;line-height:1.6;color:var(--text2);width:230px;z-index:200;pointer-events:none;transition:opacity .15s,visibility .15s;box-shadow:0 8px 28px rgba(0,0,0,.5);font-style:normal;font-weight:400;text-transform:none;letter-spacing:normal}
.tt:hover .tt-box{visibility:visible;opacity:1}
.tt-box::after{content:'';position:absolute;top:100%;left:50%;transform:translateX(-50%);border:5px solid transparent;border-top-color:#1e2128}

/* Rank badge */
.rank-tile{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:12px 14px;display:flex;flex-direction:column;gap:4px}
.rank-tile-label{font-size:10px;text-transform:uppercase;letter-spacing:.07em;color:var(--text3);font-weight:500}
.rank-tile-value{font-family:'Instrument Serif',serif;font-size:22px;line-height:1}
.rank-tile-sub{font-size:11px;color:var(--text3)}
/* =====================================================================
   NEW ONBOARDING - Full-screen Lemonade-style flow
   ===================================================================== */
/* Fullscreen gate */
.ob-overlay{position:fixed;inset:0;background:var(--bg);z-index:200;display:flex;overflow:hidden}
.ob-left{width:340px;min-width:340px;background:linear-gradient(160deg,#0e0f11 0%,#13100a 100%);border-right:1px solid var(--border);display:flex;flex-direction:column;padding:40px 36px;position:relative;overflow:hidden;flex-shrink:0}
.ob-left::before{content:'';position:absolute;bottom:-80px;left:-60px;width:260px;height:260px;background:radial-gradient(circle,rgba(200,169,110,.18) 0%,transparent 70%);pointer-events:none}
.ob-left::after{content:'';position:absolute;top:30px;right:-40px;width:120px;height:120px;background:radial-gradient(circle,rgba(200,169,110,.08) 0%,transparent 70%);pointer-events:none}
.ob-right{flex:1;display:flex;flex-direction:column;overflow:hidden;position:relative}
.ob-right-inner{flex:1;overflow-y:auto;padding:52px 60px 40px;display:flex;flex-direction:column}
.ob-right-inner::-webkit-scrollbar{width:4px}
.ob-right-inner::-webkit-scrollbar-thumb{background:var(--border2);border-radius:10px}

/* Left panel elements */
.ob-logo{display:flex;align-items:center;gap:10px;margin-bottom:48px}
.ob-logo-mark{width:32px;height:32px;background:linear-gradient(135deg,var(--accent),#7c5c2e);border-radius:8px;display:flex;align-items:center;justify-content:center;font-family:'Instrument Serif',serif;font-size:15px;color:#0e0f11}
.ob-logo-name{font-family:'Instrument Serif',serif;font-size:16px;letter-spacing:-.01em;color:var(--text2)}
.ob-steps-list{display:flex;flex-direction:column;gap:2px;flex:1}
.ob-step-item{display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:10px;transition:background .2s;cursor:default;position:relative}
.ob-step-item.clickable{cursor:pointer}
.ob-step-item.clickable:hover{background:rgba(200,169,110,.06)}
.ob-step-item.active{background:rgba(200,169,110,.1)}
.ob-step-num{width:26px;height:26px;border-radius:50%;border:1.5px solid var(--border2);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:600;color:var(--text3);flex-shrink:0;transition:all .25s}
.ob-step-item.active .ob-step-num{border-color:var(--accent);background:var(--accent);color:#0e0f11}
.ob-step-item.done .ob-step-num{border-color:var(--green);background:var(--green-dim);color:var(--green)}
.ob-step-label{font-size:12px;color:var(--text3);transition:color .2s;font-weight:400;line-height:1.3}
.ob-step-sublabel{font-size:10px;color:var(--text3);opacity:.6;line-height:1.2;margin-top:1px}
.ob-step-item.active .ob-step-label{color:var(--text);font-weight:500}
.ob-step-item.done .ob-step-label{color:var(--text3)}

.ob-progress-bar{position:absolute;bottom:0;left:0;right:0;height:2px;background:var(--border)}
.ob-progress-fill{height:100%;background:linear-gradient(90deg,var(--accent2),var(--accent));transition:width .4s cubic-bezier(.22,.68,0,1.2)}

/* Right panel */
.ob-phase-title{font-family:'Instrument Serif',serif;font-size:32px;letter-spacing:-.025em;line-height:1.15;margin-bottom:8px;color:var(--text)}
.ob-phase-sub{font-size:14px;color:var(--text3);line-height:1.6;margin-bottom:36px;max-width:560px}
.ob-content{flex:1;min-height:0}
.ob-footer{display:flex;justify-content:space-between;align-items:center;padding-top:28px;margin-top:28px;border-top:1px solid var(--border);flex-shrink:0}
.ob-footer-hint{font-size:11px;color:var(--text3)}
.ob-footer-btns{display:flex;gap:10px;align-items:center}

/* Choice cards */
.choice-card{border:1.5px solid var(--border);border-radius:14px;padding:20px 22px;cursor:pointer;transition:all .2s;display:flex;align-items:flex-start;gap:16px}
.choice-card:hover{border-color:var(--border2);background:var(--surface2)}
.choice-card.selected{border-color:var(--accent);background:rgba(200,169,110,.07)}
.choice-card-icon{font-size:26px;flex-shrink:0;margin-top:2px}
.choice-card-body{flex:1}
.choice-card-title{font-size:15px;font-weight:600;margin-bottom:4px;color:var(--text)}
.choice-card-desc{font-size:12px;color:var(--text3);line-height:1.55}
.choice-check{width:20px;height:20px;border-radius:50%;border:1.5px solid var(--border);display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .2s;margin-top:3px}
.choice-card.selected .choice-check{border-color:var(--accent);background:var(--accent);color:#0e0f11}

/* Chip toggles */
.chip{padding:7px 14px;border-radius:20px;border:1px solid var(--border);font-size:12px;cursor:pointer;transition:all .15s;color:var(--text3);background:transparent;font-weight:400;white-space:nowrap}
.chip:hover{border-color:var(--border2);color:var(--text2)}
.chip.on{border-color:var(--accent);background:rgba(200,169,110,.1);color:var(--accent);font-weight:500}
.chip-row{display:flex;flex-wrap:wrap;gap:7px}

/* Inline input groups */
.ob-field{margin-bottom:18px}
.ob-label{display:block;font-size:11px;text-transform:uppercase;letter-spacing:.07em;color:var(--text3);font-weight:500;margin-bottom:6px}
.ob-label.err{color:var(--red)}
.ob-grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.ob-grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}

/* Profile page redesign */
.profile-hero{background:linear-gradient(135deg,var(--surface) 0%,var(--surface2) 100%);border:1px solid var(--border);border-radius:20px;padding:36px 40px;margin-bottom:24px;position:relative;overflow:hidden}
.profile-hero::before{content:'';position:absolute;top:-60px;right:-60px;width:240px;height:240px;background:radial-gradient(circle,rgba(200,169,110,.1) 0%,transparent 70%);pointer-events:none}
.profile-hero::after{content:'';position:absolute;bottom:-80px;left:-40px;width:200px;height:200px;background:radial-gradient(circle,rgba(96,165,250,.05) 0%,transparent 70%);pointer-events:none}
.profile-avatar-lg{width:64px;height:64px;border-radius:16px;background:linear-gradient(135deg,var(--accent),#7c5c2e);display:flex;align-items:center;justify-content:center;font-family:'Instrument Serif',serif;font-size:28px;color:#0e0f11;flex-shrink:0;position:relative}
.profile-avatar-lg::after{content:'';position:absolute;inset:-2px;border-radius:18px;border:1px solid rgba(200,169,110,.3)}
.profile-section{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:24px 28px;margin-bottom:16px}
.profile-section-title{font-size:10px;text-transform:uppercase;letter-spacing:.1em;color:var(--accent);font-weight:600;margin-bottom:16px;padding-bottom:8px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px}
.profile-kv{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:14px}
.profile-kv-item{background:var(--surface2);border-radius:10px;padding:12px 14px}
.profile-kv-label{font-size:10px;text-transform:uppercase;letter-spacing:.07em;color:var(--text3);margin-bottom:5px;font-weight:500}
.profile-kv-value{font-size:14px;font-weight:500;color:var(--text);line-height:1.3}
.profile-kv-mono{font-family:'DM Mono',monospace;font-size:13px;font-weight:600}
.culture-pill{display:inline-flex;align-items:center;padding:5px 12px;border-radius:20px;font-size:12px;font-weight:400;background:var(--surface2);border:1px solid var(--border);color:var(--text2);margin:3px}

/* Blur gate */
.blur-cell{filter:blur(5px);user-select:none;pointer-events:none}
.lock-overlay{position:relative}
.lock-overlay::after{content:'';position:absolute;inset:0;background:linear-gradient(to bottom,transparent 30%,rgba(14,15,17,.95) 100%);pointer-events:none;border-radius:14px}
.gate-banner{background:linear-gradient(135deg,rgba(200,169,110,.12),rgba(200,169,110,.06));border:1px solid rgba(200,169,110,.3);border-radius:14px;padding:20px 24px;display:flex;align-items:center;gap:20px;margin-bottom:20px}
.gate-banner-icon{font-size:32px;flex-shrink:0}
.gate-banner-title{font-family:'Instrument Serif',serif;font-size:18px;margin-bottom:4px}
.gate-banner-sub{font-size:12px;color:var(--text3);line-height:1.6}
.form-grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.form-grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
.form-section{margin-bottom:22px}
.form-section-title{font-size:10px;text-transform:uppercase;letter-spacing:.1em;color:var(--accent);font-weight:600;margin-bottom:12px;padding-bottom:6px;border-bottom:1px solid var(--border)}
.form-field-label{display:block;font-size:11px;font-weight:500;color:var(--text3);margin-bottom:5px;text-transform:uppercase;letter-spacing:.06em}
.form-field-label.err{color:var(--red)}
.field-hint{font-size:11px;color:var(--text3);margin-top:4px}
.req{color:var(--red);margin-left:2px}
.score-meter{height:5px;border-radius:3px;background:var(--surface3);overflow:hidden;margin-top:5px}
.score-fill{height:100%;border-radius:3px;transition:width .6s cubic-bezier(.22,.68,0,1.2)}
.tt{position:relative;display:inline-block;cursor:help;border-bottom:1px dotted var(--text3)}
.tt-box{visibility:hidden;opacity:0;position:absolute;bottom:calc(100% + 8px);left:50%;transform:translateX(-50%);background:#1e2128;border:1px solid var(--border2);border-radius:9px;padding:9px 13px;font-size:11px;line-height:1.6;color:var(--text2);width:230px;z-index:200;pointer-events:none;transition:opacity .15s,visibility .15s;box-shadow:0 8px 28px rgba(0,0,0,.5);font-style:normal;font-weight:400;text-transform:none;letter-spacing:normal}
.tt:hover .tt-box{visibility:visible;opacity:1}
.tt-box::after{content:'';position:absolute;top:100%;left:50%;transform:translateX(-50%);border:5px solid transparent;border-top-color:#1e2128}
.match-card{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px 16px;transition:border-color .2s;cursor:pointer}
.match-card:hover{border-color:var(--border2)}
.match-score-pill{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600}
.rank-tile{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:12px 14px;display:flex;flex-direction:column;gap:4px}
.rank-tile-label{font-size:10px;text-transform:uppercase;letter-spacing:.07em;color:var(--text3);font-weight:500}
.rank-tile-value{font-family:'Instrument Serif',serif;font-size:22px;line-height:1}
.rank-tile-sub{font-size:11px;color:var(--text3)}
@keyframes obSlideIn{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
@keyframes obSlideOut{from{opacity:1;transform:translateX(0)}to{opacity:0;transform:translateX(-20px)}}
.ob-slide-in{animation:obSlideIn .28s cubic-bezier(.22,.68,0,1.1) both}
/* CRM / Pipeline */
.pipeline-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px 20px;transition:border-color .2s}
.pipeline-card:hover{border-color:var(--border2)}
.touch-step{display:flex;align-items:center;gap:10px;padding:7px 10px;border-radius:8px;cursor:pointer;transition:all .15s;border:1px solid transparent}
.touch-step:hover{background:var(--surface2)}
.touch-step.active{background:rgba(200,169,110,.08);border-color:var(--accent)}
.touch-step.done{opacity:.6}
.touch-dot{width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;flex-shrink:0}
.agg-card{padding:8px 12px;border-radius:8px;border:1px solid var(--border);cursor:pointer;transition:all .15s}
.agg-card:hover{border-color:var(--border2)}
.agg-card.selected{border-color:var(--accent);background:rgba(200,169,110,.08)}

</style>
</head>
<body>
<div id="root"></div>
<script src="ria-data.js"></script>
<script type="text/babel">
const {useState,useMemo,useRef,useEffect,useCallback} = React;

// =============================================================================
// DATA ARCHITECTURE
// BASE LAYER: FIRMS[] â€” from ria-data.js (FR). FROZEN. Never mutated.
// PROFILE LAYER: localStorage('ria_user_profile') â€” completely separate.
// BD FIRMS: Injected into runtime search pool (getBDFirm) at render time only.
// =============================================================================

const FIRMS = Object.freeze(FR.map(f => Object.freeze({
  name:f.n, legal:f.l, crd:f.crd, addr1:f.a1, addr2:f.a2, city:f.ci, state:f.st, zip:f.z,
  phone:f.ph, website:f.w, orgType:f.ot, secStatus:f.ss, statusDate:f.sd, advDate:f.ad,
  aum:f.au, aumDisc:f.aud, aumNonDisc:f.aun, accounts:f.ac, employees:f.em,
  clientsInd:f.ci_, aumInd:f.aui, clientsHNW:f.ch, aumHNW:f.auh,
  clientsPension:f.cp, clientsCharitable:f.cc, clientsCorp:f.cb, clientsPooled:f.cpl,
  services:f.sv, compensation:f.co, clientTypes:f.ct,
  custody:f.cu, custodyAmt:f.cua, disclosures:f.di,
  bdAffiliate:f.bd, iaAffiliate:f.ia, iaAffCount:f.iac, bdAffCount:f.bdc,
  wrapFee:f.wf, privateRes:f.pr, otherOffices:f.oo,
  aumPension:f.aup, aumCharitable:f.auc, aumCorp:f.aub, aumPooled:f.aupl,
  stateOfFormation:f.sf, cpoAffiliate:f.cpo, fax:f.fx,
})));

// Build a synthetic firm record from a BD profile â€” injected at runtime
// into search/map pools. Never stored back into FIRMS.
function buildBDFirmRecord(profile) {
  if (!profile || profile.type !== 'bd') return null;
  return {
    _isBD: true, _profileId: 'user',
    name: profile.firmName || 'My Firm',
    legal: profile.firmLegal || '',
    crd: '__bd__',
    addr1: profile.addr1 || '', addr2: profile.addr2 || '',
    city: profile.city || '', state: profile.state || '', zip: profile.zip || '',
    phone: profile.phone || '', website: profile.website || '',
    orgType: profile.employmentType || 'BD Team',
    secStatus: 'Non-RIA', statusDate: '', advDate: '',
    aum: profile.aum || 0,
    aumDisc: profile.aumDisc || null,
    aumNonDisc: null,
    accounts: profile.accounts || null,
    employees: profile.intel?.teamSize || null,
    clientsInd: profile.clientsInd || null,
    aumInd: null, clientsHNW: profile.clientsHNW || null, aumHNW: null,
    clientsPension: null, clientsCharitable: null, clientsCorp: null, clientsPooled: null,
    services: profile.services || [], compensation: profile.compensation || [],
    clientTypes: [], custody: false, custodyAmt: null, disclosures: false,
    bdAffiliate: true, iaAffiliate: false, iaAffCount: 0, bdAffCount: 0,
    wrapFee: false, privateRes: false, otherOffices: 0,
    aumPension: null, aumCharitable: null, aumCorp: null, aumPooled: null,
    stateOfFormation: '', cpoAffiliate: false, fax: '',
  };
}

// Runtime pool â€” FIRMS + optional BD record for search/map/dashboard
function getFirmPool(profile) {
  const bd = buildBDFirmRecord(profile);
  return bd ? [...FIRMS, bd] : [...FIRMS];
}

// Formatters
const fmt  = v => v != null ? '$' + Math.round(v).toLocaleString() : '-';
const fmtM = v => { if(v==null) return '-'; if(v>=1e12) return '$'+(v/1e12).toFixed(1)+'T'; if(v>=1e9) return '$'+(v/1e9).toFixed(2).replace(/\.?0+$/,'')+'B'; if(v>=1e6) return '$'+(v/1e6).toFixed(1).replace(/\.0$/,'')+'M'; if(v>=1e3) return '$'+Math.round(v/1e3).toLocaleString()+'K'; return '$'+Math.round(v).toLocaleString(); };
const fmtN = v => v != null ? v.toLocaleString() : '-';
const wu   = r => { if(!r) return null; const u=r.trim(); if(!u) return null; return /^https?:\/\//i.test(u)?u:'https://'+u; };
window.__rvf = null;

// =============================================================================
// SCHEMA CONSTANTS
// =============================================================================
const AUM_BANDS            = ['0â€“100M','100â€“250M','250â€“500M','500Mâ€“1B','1B+'];
const OWNERSHIP_STRUCTS    = ['Solo owner','2 partners','3+ partners','Corporate owned'];
const FOUNDER_AGE_BANDS    = ['<40','40â€“49','50â€“59','60â€“64','65+'];
const SUCCESSION_TIMELINES = ['None / not considering','5+ years','3â€“5 years','1â€“3 years','Actively exploring'];
const GEO_FLEXIBILITIES    = ['None â€” local only','Regional','National'];
const GROWTH_INTENTS       = ['Organic only','Acquisitive','Strategic partnership','Undecided'];
const SERVICES_OPTS        = ['Financial Planning','Portfolio Management','Tax Advisory','Estate Planning','Retirement Planning','Business Planning','Insurance','Other'];
const COMP_OPTS            = ['AUM-based fee','Flat fee','Hourly','Commission','Performance-based','Other'];
const EMPLOYMENT_TYPES     = ['W2 â€” wirehouse (UBS, Merrill, Morgan Stanley, etc.)','W2 â€” independent (LPL, Raymond James, Steward, etc.)','1099 â€” independent contractor','Hybrid / Other'];
const CLIENT_APPROACH_OPTS = ['Planning-focused','Investment-focused','Insurance / annuity-focused','Tax-integrated','Holistic / comprehensive'];
const REVIEW_OPTS          = ['Annual','Semi-annual','Quarterly','On-request only','Tax-return review included'];
const CRM_OPTS             = ['Salesforce','Redtail','Wealthbox','Junxure','HubSpot','Proprietary/custom','Other'];
const FP_OPTS              = ['eMoney','MoneyGuidePro','RightCapital','NaviPlan','Proprietary/custom','None'];
const PMS_OPTS             = ['Black Diamond','Orion','Tamarac','Advent','Charles River','Proprietary/custom','Other'];
const CUSTODIANS           = ['Schwab','Fidelity','Pershing','Raymond James','LPL','Ameriprise','Other'];
const CULTURE_OPTS         = ['Office lunch provided','Weekly team meetings','Monthly firm outings','Remote-first culture','In-person first','Strong mentorship','Flat hierarchy','Formal review structure','Client-event culture','Charity / community focus'];

const EMPTY_INTEL = {
  // Quantitative
  teamSize: null, supportStaff: null, numAdvisors: null,
  aumBand: null, aumDiscPct: null,
  clientsHNW: null, clientsInd: null,
  advisorAgeBands: [], // array: e.g. ['40â€“49','50â€“59']
  ownershipStructure: null,
  internalSuccessorIdentified: null, successionTimeline: null,
  openToMinorityCapital: null, openToFullSale: null,
  seekingAcquisitions: null, hiringJuniorAdvisors: null,
  geographicFlexibility: null, growthIntent: null,
  // Qualitative culture
  clientApproach: [], reviewCadence: [],
  reviewTaxReturns: null,
  officeEnvironment: null, // 'Remote','Hybrid','In-person'
  cultureTraits: [],
  // Qualitative operations
  crm: [], financialPlanning: [], portfolioMgmt: [], custodians: [],
  techNotes: '',
};

// Profile storage
function loadProfile()  { try { return JSON.parse(localStorage.getItem('ria_user_profile') || 'null'); } catch(e) { return null; } }
function saveProfile(p) { try { localStorage.setItem('ria_user_profile', JSON.stringify(p)); } catch(e) {} }
function clearProfile() { try { localStorage.removeItem('ria_user_profile'); } catch(e) {} }
function loadSaved()    { try { return new Set(JSON.parse(localStorage.getItem('ria_saved') || '[]')); } catch(e) { return new Set(); } }
function saveSaved(s)   { try { localStorage.setItem('ria_saved', JSON.stringify([...s])); } catch(e) {} }
function loadNotes()    { try { return JSON.parse(localStorage.getItem('ria_notes') || '{}'); } catch(e) { return {}; } }
function saveNotes(n)   { try { localStorage.setItem('ria_notes', JSON.stringify(n)); } catch(e) {} }

// CRM storage
function loadCRM()  { try { return JSON.parse(localStorage.getItem('ria_crm') || '{}'); } catch(e) { return {}; } }
function saveCRM(c) { try { localStorage.setItem('ria_crm', JSON.stringify(c)); } catch(e) {} }

// =============================================================================
// CADENCE ENGINE
// =============================================================================
const CADENCE_SEQUENCES = {
  measured: [
    { touchNum: 1, type: 'letter', label: 'Initial Letter',           daysAfterPrev: 0,  desc: 'Handwritten or typed physical letter. No hard ask -- just introduction and a clear signal of interest.' },
    { touchNum: 2, type: 'letter', label: 'Follow-up Letter',         daysAfterPrev: 30, desc: 'Brief second letter. Reference that you reached out previously. Reiterate interest, add one new angle.' },
    { touchNum: 3, type: 'email',  label: 'Email Introduction',       daysAfterPrev: 21, desc: 'Short email. Reference both prior letters. Single clear ask: 15-minute call.' },
    { touchNum: 4, type: 'pause',  label: 'Quiet Period (60 days)',   daysAfterPrev: 60, desc: 'No contact. Let the sequence breathe. If they respond at any point, move to active dialogue.' },
    { touchNum: 5, type: 'letter', label: 'Re-engagement Letter',     daysAfterPrev: 0,  desc: 'Fresh outreach after quiet period. Seasonal or circumstantial hook if possible.' },
  ],
  active: [
    { touchNum: 1, type: 'letter', label: 'Initial Letter',           daysAfterPrev: 0,  desc: 'Physical letter. Clear purpose, specific to their firm, one concrete call to action.' },
    { touchNum: 2, type: 'email',  label: 'Email Follow-up',          daysAfterPrev: 14, desc: 'Email referencing the letter. Brief, respectful. Offer a specific date/time for a call.' },
    { touchNum: 3, type: 'letter', label: 'Second Letter',            daysAfterPrev: 21, desc: 'Second physical letter. New angle or updated context. Acknowledge no response -- keep tone positive.' },
    { touchNum: 4, type: 'phone',  label: 'Phone / Voicemail',        daysAfterPrev: 10, desc: 'Brief voicemail or call. Reference all prior outreach. Keep it under 30 seconds. No pressure.' },
    { touchNum: 5, type: 'email',  label: 'Break-up Email',           daysAfterPrev: 14, desc: 'Final email. Acknowledge they may not be interested. Leave the door open gracefully.' },
    { touchNum: 6, type: 'pause',  label: 'Quiet Period (90 days)',   daysAfterPrev: 90, desc: 'Full stop. Re-evaluate after 90 days.' },
    { touchNum: 7, type: 'letter', label: 'Re-engagement Letter',     daysAfterPrev: 0,  desc: 'Fresh outreach after quiet period. Treat as near-new contact.' },
  ],
  persistent: [
    { touchNum: 1, type: 'letter', label: 'Initial Letter',           daysAfterPrev: 0,  desc: 'Strong opening letter. Clear purpose, specific data points about their firm, direct ask.' },
    { touchNum: 2, type: 'email',  label: 'Email (Day 7)',            daysAfterPrev: 7,  desc: 'Quick email referencing the letter. One sentence on why this is worth their time.' },
    { touchNum: 3, type: 'phone',  label: 'Phone (Day 10)',           daysAfterPrev: 3,  desc: 'Call or voicemail. Reference letter and email. Specific value proposition in 20 seconds.' },
    { touchNum: 4, type: 'email',  label: 'Email with Insight',       daysAfterPrev: 7,  desc: 'Email with a useful data point or market insight. Soft ask -- reply to discuss.' },
    { touchNum: 5, type: 'letter', label: 'Second Letter',            daysAfterPrev: 14, desc: 'Second physical letter. Updated narrative. Reference market conditions or timing factors.' },
    { touchNum: 6, type: 'phone',  label: 'Phone Follow-up',          daysAfterPrev: 7,  desc: 'Second call attempt. More direct. Ask for a specific 15-minute window.' },
    { touchNum: 7, type: 'email',  label: 'Break-up Email',           daysAfterPrev: 7,  desc: 'Final email. Assume no interest but leave door open. Short and graceful.' },
    { touchNum: 8, type: 'pause',  label: 'Quiet Period (60 days)',   daysAfterPrev: 60, desc: 'Stop all contact. Re-evaluate after 60 days.' },
    { touchNum: 9, type: 'letter', label: 'Re-engagement Letter',     daysAfterPrev: 0,  desc: 'Fresh start after quiet period. New angle if possible.' },
  ],
};

const TYPE_ICON = { letter: 'âœ‰', email: 'ðŸ“§', phone: 'ðŸ“ž', pause: 'â¸' };
const TYPE_COLOR = { letter: 'var(--accent)', email: 'var(--blue)', phone: 'var(--green)', pause: 'var(--text3)' };
const AGG_LABELS = { measured: 'Measured', active: 'Active', persistent: 'Persistent' };

function buildTouchPrompt({ touch, firm, roa, profile, purpose, aggressiveness, prevTouches, ctx, sN, sT, sF, sA }) {
  const rev = (firm.aum || 0) * roa;
  const pMap = {
    acquisition: 'exploring a potential acquisition or merger of their firm',
    partnership: 'exploring a strategic partnership or affiliation',
    recruiting:  'recruiting their advisors or team to join your firm',
    services:    'offering professional services (compliance, technology, operations)',
    referral:    'establishing a referral relationship',
  };
  const aggMap = {
    measured:   'patient and understated -- never pushy, always leaving the door open',
    active:     'professional and direct -- respectful of their time but clear about intent',
    persistent: 'confident and persistent -- clear ask, specific timing, outcome-oriented',
  };
  const history = prevTouches.length > 0
    ? 'PRIOR OUTREACH HISTORY:\n' + prevTouches.map(t =>
        '  Touch ' + t.touchNum + ' (' + t.label + ') -- sent ' + (t.sentAt ? new Date(t.sentAt).toLocaleDateString() : 'date unknown') +
        (t.notes ? '\n  Note: ' + t.notes : '')
      ).join('\n')
    : 'PRIOR OUTREACH: None -- this is the first contact.';

  const isLetter = touch.type === 'letter';
  const isEmail  = touch.type === 'email';
  const isPhone  = touch.type === 'phone';

  const lines = [
    isLetter ? 'Write a personalized physical letter to be mailed to an RIA firm.' :
    isEmail  ? 'Write a concise, professional outreach email to an RIA firm.' :
               'Write a brief, natural-sounding voicemail script to leave for an RIA firm principal.',
    '',
    'TOUCH: #' + touch.touchNum + ' of the sequence -- ' + touch.label,
    'TOUCH DESCRIPTION: ' + touch.desc,
    '',
    'SENDER:',
    'Name: ' + (sN || '[Your Name]'),
    'Title: ' + (sT || '[Your Title]'),
    'Firm: ' + (sF || '[Your Firm]'),
    isLetter ? 'Address: ' + (sA || '[Your Address]') : '',
    '',
    'RECIPIENT FIRM (from SEC Form ADV):',
    'Firm: ' + firm.name + ' (CRD #' + firm.crd + ')',
    'Address: ' + firm.addr1 + (firm.addr2 ? ', ' + firm.addr2 : '') + ', ' + firm.city + ', ' + firm.state + ' ' + firm.zip,
    'Total RAUM: $' + Math.round(firm.aum || 0).toLocaleString(),
    'Discretionary RAUM: $' + Math.round(firm.aumDisc || 0).toLocaleString(),
    'Est Revenue (at ' + (roa * 100).toFixed(2) + '% ROA): $' + Math.round(rev).toLocaleString(),
    'Employees: ' + (firm.employees || 'N/A'),
    'Individual Clients: ' + (firm.clientsInd || 'N/A') + ', HNW Clients: ' + (firm.clientsHNW || 'N/A'),
    'Services: ' + (firm.services || []).join(', '),
    'Compensation: ' + (firm.compensation || []).join(', '),
    'Org Type: ' + firm.orgType,
    'BD Affiliate: ' + (firm.bdAffiliate ? 'Yes' : 'No') + ', Custody: ' + (firm.custody ? 'Yes' : 'No'),
    '',
    history,
    '',
    'PURPOSE: ' + (pMap[purpose] || purpose),
    'AGGRESSIVENESS: ' + (aggMap[aggressiveness] || aggressiveness),
    'ADDITIONAL CONTEXT: ' + (ctx || 'None'),
    '',
    'INSTRUCTIONS:',
  ];

  if (isLetter) {
    lines.push(
      '- Professional letter for physical mail (date, addresses, salutation, body, closing)',
      touch.touchNum === 1 ? '- This is first contact -- no reference to prior outreach' : '- Reference prior outreach naturally',
      '- Reference their ADV data naturally to show you did homework, not heavy-handed',
      '- 250-350 word body, one page',
      '- No hype, buzzwords, or marketing language',
      '- Do NOT mention dollar amounts of AUM or revenue -- reference scale indirectly',
      '- Address to The Principals',
      '- Signal sophistication without being promotional',
      '- Do NOT use em dashes',
      '- End with a specific, low-pressure call to action'
    );
  } else if (isEmail) {
    lines.push(
      '- Short professional email -- 150 words maximum',
      '- Subject line: specific, non-salesy (not "Quick Question" or "Exciting Opportunity")',
      touch.touchNum === 1 ? '- This is first contact' : '- Open by briefly referencing prior physical letter(s)',
      '- Single clear ask -- a call, a reply, or a specific date',
      '- Do NOT use em dashes',
      '- Provide: SUBJECT LINE, then EMAIL BODY'
    );
  } else {
    lines.push(
      '- Voicemail script -- 25-30 seconds when read aloud (approx 60-70 words)',
      '- Natural, unhurried pacing -- not a sales pitch',
      '- State name, firm, and reason for calling in one sentence',
      touch.touchNum <= 2 ? '- Reference the letter you sent' : '- Briefly reference the sequence of prior outreach',
      '- State your callback number twice',
      '- Do NOT use em dashes'
    );
  }

  return lines.filter(l => l !== '').join('\n');
}

// =============================================================================
// INTELLIGENCE ENGINE
// =============================================================================
function calcSuccessionScore(intel) {
  if (!intel) return null;
  let s = 0;
  if (intel.advisorAgeBands?.includes('60â€“64')) s += 20;
  if (intel.advisorAgeBands?.includes('65+'))   s += 30;
  if (intel.internalSuccessorIdentified === false) s += 25;
  if (intel.ownershipStructure === 'Solo owner') s += 15;
  if (intel.successionTimeline === 'Actively exploring') s += 10;
  if (intel.teamSize === 1) s += 10;
  return Math.min(100, s);
}
function calcAcquisitionScore(intel) {
  if (!intel) return null;
  let s = 0;
  if (intel.seekingAcquisitions === true) s += 30;
  if (intel.growthIntent === 'Acquisitive') s += 25;
  if (intel.teamSize >= 3) s += 15;
  if (intel.hiringJuniorAdvisors === true) s += 10;
  if (intel.geographicFlexibility === 'Regional' || intel.geographicFlexibility === 'National') s += 10;
  return Math.min(100, s);
}
function calcFitScore(profile, targetFirm) {
  // Goodness-of-fit matching beyond size/geo
  if (!profile?.intel) return 0;
  const intel = profile.intel;
  let s = 0;
  // Service overlap
  const svc = profile.services || [];
  const overlap = svc.filter(x => targetFirm.services?.includes(x)).length;
  s += overlap * 8;
  // Comp model overlap
  const comp = profile.compensation || [];
  s += comp.filter(x => targetFirm.compensation?.includes(x)).length * 6;
  return Math.min(40, s);
}

function derivedAumBand(aum) {
  if (!aum || aum < 100e6) return '0â€“100M';
  if (aum < 250e6) return '100â€“250M';
  if (aum < 500e6) return '250â€“500M';
  if (aum < 1e9)   return '500Mâ€“1B';
  return '1B+';
}

function matchFirms(profile, roa, mode) {
  const intel = profile.intel || {};
  return FIRMS
    .filter(f => f.aum > 0)
    .map(f => {
      let score = 0;
      if (profile.state && f.state === profile.state) score += 20;
      if (mode === 'acquire') {
        if (profile.aum && f.aum < profile.aum * 0.7) score += 15;
        if (f.employees <= 5) score += 10;
      }
      if (mode === 'sell') {
        if (profile.aum && f.aum > profile.aum * 1.5) score += 15;
      }
      if (mode === 'partner') {
        if (profile.aum && Math.abs(f.aum - profile.aum) / profile.aum < 0.5) score += 15;
        if (profile.state && f.state !== profile.state) score += 10;
      }
      score += calcFitScore(profile, f);
      return { firm: f, score, rev: (f.aum || 0) * roa };
    })
    .filter(m => m.score > 0)
    .sort((a, b) => b.score - a.score)
    .slice(0, 10);
}

const STATE_CENTROIDS = {
  NH:{lat:43.97,lng:-71.57},VT:{lat:44.00,lng:-72.70},MA:{lat:42.26,lng:-71.81},
  ME:{lat:45.25,lng:-69.44},CT:{lat:41.60,lng:-72.69},RI:{lat:41.68,lng:-71.51},
  NY:{lat:42.17,lng:-74.95},NJ:{lat:40.22,lng:-74.76},PA:{lat:40.59,lng:-77.21},
  FL:{lat:27.77,lng:-81.69},TX:{lat:31.05,lng:-97.56},CA:{lat:36.78,lng:-119.42},
  IL:{lat:40.35,lng:-88.99},WA:{lat:47.38,lng:-120.45},CO:{lat:39.11,lng:-105.36},
  GA:{lat:32.16,lng:-82.90},NC:{lat:35.63,lng:-79.81},VA:{lat:37.77,lng:-78.17},
  OH:{lat:40.19,lng:-82.67},AZ:{lat:34.05,lng:-111.09},MN:{lat:46.39,lng:-94.64},
  WI:{lat:44.27,lng:-89.62},MO:{lat:38.46,lng:-92.29},OR:{lat:43.94,lng:-120.56},
  IN:{lat:39.85,lng:-86.26},MD:{lat:39.05,lng:-76.64},TN:{lat:35.86,lng:-86.66},
  MI:{lat:44.18,lng:-84.51},SC:{lat:33.84,lng:-80.90},
};

function geocodeUserFirm(profile) {
  if (!profile || profile.type !== 'bd') return null;
  const city = (profile.city || '').toLowerCase().trim();
  const state = profile.state;
  if (!state) return null;
  const cityMatch = FIRMS.find(f =>
    f.state === state && f.city && f.city.toLowerCase().trim() === city && COORDS[f.crd]
  );
  if (cityMatch) return { ...profile, lat: COORDS[cityMatch.crd].lat, lng: COORDS[cityMatch.crd].lng };
  const c = STATE_CENTROIDS[state];
  if (c) return { ...profile, lat: c.lat, lng: c.lng };
  return null;
}

// =============================================================================
// SHARED PRIMITIVES
// =============================================================================
function StarBtn({ crd, saved, toggleSave }) {
  return (
    <button className={'star-btn' + (saved.has(crd) ? ' starred' : '')}
      onClick={e => { e.stopPropagation(); toggleSave(crd); }}
      title={saved.has(crd) ? 'Remove from targets' : 'Save as target'}>
      {saved.has(crd) ? 'â˜…' : 'â˜†'}
    </button>
  );
}
function ScoreMeter({ score, color, label }) {
  const c = color || 'var(--accent)';
  return (
    <div>
      <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 3 }}>
        <span style={{ fontSize: 11, color: 'var(--text3)' }}>{label}</span>
        <span style={{ fontFamily: 'DM Mono,monospace', fontSize: 11, color: c, fontWeight: 600 }}>{score}/100</span>
      </div>
      <div className="score-meter"><div className="score-fill" style={{ width: score + '%', background: c }} /></div>
    </div>
  );
}
function BlurredCell({ children }) {
  return <span className="blur-cell">{children}</span>;
}
function GateBanner({ onOpenOnboarding }) {
  return (
    <div className="gate-banner">
      <div className="gate-banner-icon">ðŸ”’</div>
      <div style={{ flex: 1 }}>
        <div className="gate-banner-title">Create a profile to unlock full data</div>
        <div className="gate-banner-sub">AUM, revenue, client counts, and intelligence are hidden until you create your firm profile. Takes about 3 minutes.</div>
      </div>
      <button className="btn-gold" onClick={onOpenOnboarding}>Create Profile â†’</button>
    </div>
  );
}
function FormField({ label, required, err, hint, children, span }) {
  return (
    <div style={{ gridColumn: span ? '1 / -1' : undefined }}>
      <label className={'form-field-label' + (err ? ' err' : '')}>
        {label}{required && <span className="req">*</span>}
        {err && <span style={{ fontWeight: 400, textTransform: 'none', letterSpacing: 'normal', marginLeft: 6 }}>{err}</span>}
      </label>
      {children}
      {hint && <div className="field-hint">{hint}</div>}
    </div>
  );
}
function Chips({ options, selected, onToggle, size }) {
  return (
    <div className="chip-row">
      {options.map(o => (
        <div key={o} className={'chip' + (selected.includes(o) ? ' on' : '')}
          onClick={() => onToggle(o)}
          style={size === 'sm' ? { padding: '5px 11px', fontSize: 11 } : {}}>
          {o}
        </div>
      ))}
    </div>
  );
}

// =============================================================================
// ONBOARDING â€” Full-screen Lemonade-style flow
// 4 Phases: (0) Who are you, (1) Firm basics + quant, (2) Culture & fit, (3) Operations
// =============================================================================
function OnboardingModal({ onComplete, onClose }) {
  const [phase, setPhase] = useState(0);
  const [animKey, setAnimKey] = useState(0);
  const [errors, setErrors] = useState({});

  // Phase 0 â€” Identity
  const [profileType, setProfileType] = useState(null); // 'bd' | 'claimed'
  const [claimCrd, setClaimCrd] = useState('');

  // Phase 1 â€” Firm basics (BD only)
  const [firmName, setFirmName] = useState('');
  const [firmLegal, setFirmLegal] = useState('');
  const [employmentType, setEmploymentType] = useState('');
  const [addr1, setAddr1] = useState('');
  const [addr2, setAddr2] = useState('');
  const [city, setCity] = useState('');
  const [state, setState] = useState('');
  const [zip, setZip] = useState('');
  const [phone, setPhone] = useState('');
  const [website, setWebsite] = useState('');
  const [selfAum, setSelfAum] = useState('');
  const [selfAumDisc, setSelfAumDisc] = useState('');
  const [selfAccounts, setSelfAccounts] = useState('');
  const [selfIndClients, setSelfIndClients] = useState('');
  const [selfHNWClients, setSelfHNWClients] = useState('');
  const [selectedServices, setSelectedServices] = useState([]);
  const [selectedComp, setSelectedComp] = useState([]);

  // Intelligence/qualitative (both types, phase 2â€“3)
  const [intel, setIntel] = useState({ ...EMPTY_INTEL });
  const setI = (k, v) => setIntel(prev => ({ ...prev, [k]: v }));
  const setBoolI = (k, v) => setI(k, v === '' ? null : v === 'true');
  const setIntI = (k, v) => setI(k, v === '' ? null : (parseInt(v, 10) || null));
  const toggleArr = (k, v) => setIntel(prev => {
    const arr = prev[k] || [];
    return { ...prev, [k]: arr.includes(v) ? arr.filter(x => x !== v) : [...arr, v] };
  });
  const toggleSvc = (v, arr, setArr) => setArr(prev => prev.includes(v) ? prev.filter(x => x !== v) : [...prev, v]);

  const claimedFirm = FIRMS.find(f => f.crd === claimCrd);

  const PHASES = [
    { label: 'Who you are', sublabel: 'RIA or BD team' },
    { label: 'Your firm', sublabel: 'Quantitative data' },
    { label: 'Culture & fit', sublabel: 'Qualitative profile' },
    { label: 'Operations', sublabel: 'Tech & workflow' },
  ];

  const progressPct = ((phase) / PHASES.length) * 100;

  const goPhase = (n) => {
    setPhase(n);
    setAnimKey(k => k + 1);
    setErrors({});
  };

  const validatePhase0 = () => {
    const e = {};
    if (!profileType) e.profileType = 'Select a profile type';
    if (profileType === 'claimed' && !claimCrd) e.claimCrd = 'Select your firm';
    setErrors(e);
    return Object.keys(e).length === 0;
  };

  const validatePhase1 = () => {
    if (profileType === 'claimed') return true; // claimed data comes from ADV
    const e = {};
    if (!firmName.trim()) e.firmName = 'Required';
    if (!city.trim()) e.city = 'Required';
    if (!state) e.state = 'Required';
    if (!zip.trim()) e.zip = 'Required';
    setErrors(e);
    return Object.keys(e).length === 0;
  };

  const handleNext = () => {
    if (phase === 0 && !validatePhase0()) return;
    if (phase === 1 && !validatePhase1()) return;
    if (phase < PHASES.length - 1) { goPhase(phase + 1); return; }
    // Complete
    const base = profileType === 'claimed'
      ? { type: 'claimed', crd: claimCrd, firmName: claimedFirm?.name || '', createdAt: new Date().toISOString() }
      : {
          type: 'bd', createdAt: new Date().toISOString(),
          firmName: firmName.trim(), firmLegal: firmLegal.trim(),
          employmentType,
          addr1: addr1.trim(), addr2: addr2.trim(), city: city.trim(), state, zip: zip.trim(),
          phone: phone.trim(), website: website.trim(),
          aum: parseFloat(selfAum) * 1e6 || null,
          aumDisc: parseFloat(selfAumDisc) * 1e6 || null,
          accounts: parseInt(selfAccounts) || null,
          clientsInd: parseInt(selfIndClients) || null,
          clientsHNW: parseInt(selfHNWClients) || null,
          services: selectedServices, compensation: selectedComp,
        };
    const profile = { ...base, intel: { ...intel } };
    saveProfile(profile);
    onComplete(profile);
  };

  const canGoBack = phase > 0;

  return (
    <div className="ob-overlay">
      {/* Left panel */}
      <div className="ob-left">
        <div className="ob-logo">
          <div className="ob-logo-mark">RI</div>
          <span className="ob-logo-name">RIA Intelligence</span>
        </div>
        <div className="ob-steps-list">
          {PHASES.map((ph, i) => (
            <div key={i} className={'ob-step-item' + (i < phase ? ' done clickable' : i === phase ? ' active' : '')}
              onClick={() => i < phase ? goPhase(i) : null}>
              <div className="ob-step-num">{i < phase ? 'âœ“' : i + 1}</div>
              <div>
                <div className="ob-step-label">{ph.label}</div>
                <div className="ob-step-sublabel">{ph.sublabel}</div>
              </div>
            </div>
          ))}
        </div>
        <div style={{ marginTop: 'auto', paddingTop: 32 }}>
          <div style={{ fontSize: 10, color: 'var(--text3)', textTransform: 'uppercase', letterSpacing: '.08em', marginBottom: 8, fontWeight: 500 }}>Progress</div>
          <div style={{ height: 3, background: 'var(--border)', borderRadius: 3, overflow: 'hidden' }}>
            <div style={{ height: '100%', background: 'linear-gradient(90deg,var(--accent2),var(--accent))', width: (progressPct + 25) + '%', transition: 'width .4s cubic-bezier(.22,.68,0,1.2)', borderRadius: 3 }} />
          </div>
          <div style={{ fontSize: 11, color: 'var(--text3)', marginTop: 8 }}>Step {phase + 1} of {PHASES.length}</div>
        </div>
        {onClose && (
          <button className="btn-ghost btn-sm" onClick={onClose} style={{ marginTop: 20, fontSize: 11, color: 'var(--text3)', border: 'none', padding: '6px 0' }}>âœ• Exit</button>
        )}
      </div>

      {/* Right panel */}
      <div className="ob-right">
        <div className="ob-right-inner">
          {/* PHASE 0 â€” Identity */}
          {phase === 0 && (
            <div key={animKey} className="ob-slide-in" style={{ flex: 1 }}>
              <div className="ob-phase-title">How are you registered?</div>
              <div className="ob-phase-sub">This determines how your firm is set up in the platform. Both options give you full access to the RIA database and private intelligence tools.</div>
              <div style={{ display: 'flex', flexDirection: 'column', gap: 12, marginBottom: 28 }}>
                <div className={'choice-card' + (profileType === 'bd' ? ' selected' : '')} onClick={() => setProfileType('bd')}>
                  <div className="choice-card-icon">ðŸ¢</div>
                  <div className="choice-card-body">
                    <div className="choice-card-title">BD / Non-RIA team</div>
                    <div className="choice-card-desc">I'm affiliated with a broker-dealer or wirehouse â€” e.g. Jones Group at UBS, Smith Team at Merrill Lynch, or an LPL / Raymond James practice. My firm isn't independently SEC-registered.</div>
                  </div>
                  <div className="choice-check">{profileType === 'bd' ? 'âœ“' : ''}</div>
                </div>
                <div className={'choice-card' + (profileType === 'claimed' ? ' selected' : '')} onClick={() => setProfileType('claimed')}>
                  <div className="choice-card-icon">ðŸ“‹</div>
                  <div className="choice-card-body">
                    <div className="choice-card-title">Claim an SEC-registered RIA</div>
                    <div className="choice-card-desc">My firm is independently registered and appears in the SEC Form ADV database. I'll claim it â€” AUM, accounts, and employee data carry over automatically from the public filing.</div>
                  </div>
                  <div className="choice-check">{profileType === 'claimed' ? 'âœ“' : ''}</div>
                </div>
              </div>
              {profileType === 'claimed' && (
                <div className="ob-slide-in ob-field">
                  <label className={'ob-label' + (errors.claimCrd ? ' err' : '')}>Find your firm in the SEC database <span className="req">*</span></label>
                  <select value={claimCrd} onChange={e => setClaimCrd(e.target.value)} style={{ borderColor: errors.claimCrd ? 'var(--red)' : '' }}>
                    <option value="">Search by name...</option>
                    {FIRMS.slice().sort((a, b) => a.name.localeCompare(b.name)).map(f => <option key={f.crd} value={f.crd}>{f.name} â€” {f.city}, {f.state} â€” {fmtM(f.aum)}</option>)}
                  </select>
                  {claimedFirm && (
                    <div style={{ background: 'var(--surface2)', border: '1px solid var(--green)', borderRadius: 10, padding: '14px 16px', marginTop: 10 }} className="ob-slide-in">
                      <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 10 }}>
                        <span style={{ color: 'var(--green)', fontSize: 14 }}>âœ“</span>
                        <span style={{ fontWeight: 600, fontSize: 15 }}>{claimedFirm.name}</span>
                        <span className="tag tag-state">{claimedFirm.state}</span>
                      </div>
                      <div style={{ display: 'flex', gap: 16, fontFamily: 'DM Mono,monospace', fontSize: 12 }}>
                        <span>RAUM <b style={{ color: 'var(--accent)' }}>{fmtM(claimedFirm.aum)}</b></span>
                        <span>Accts <b>{fmtN(claimedFirm.accounts)}</b></span>
                        <span>Emp <b>{fmtN(claimedFirm.employees)}</b></span>
                      </div>
                    </div>
                  )}
                </div>
              )}
            </div>
          )}

          {/* PHASE 1 â€” Firm basics */}
          {phase === 1 && (
            <div key={animKey} className="ob-slide-in" style={{ flex: 1 }}>
              {profileType === 'claimed' ? (
                <>
                  <div className="ob-phase-title">Your quantitative profile</div>
                  <div className="ob-phase-sub">Add intelligence fields for your claimed RIA. The ADV data carries over automatically â€” this is private context that powers matching.</div>
                  <QuantFields intel={intel} setI={setI} setBoolI={setBoolI} setIntI={setIntI} toggleArr={toggleArr} errors={errors} />
                </>
              ) : (
                <>
                  <div className="ob-phase-title">Tell us about your practice</div>
                  <div className="ob-phase-sub">This is your firm's public-facing data â€” it will appear on the map and in searches alongside SEC-registered RIAs.</div>
                  <div className="ob-field">
                    <label className={'ob-label' + (errors.firmName ? ' err' : '')}>Team / Practice name <span className="req">*</span></label>
                    <input value={firmName} onChange={e => setFirmName(e.target.value)} placeholder="e.g. Jones Group at UBS" style={{ borderColor: errors.firmName ? 'var(--red)' : '' }} />
                    <div style={{ fontSize: 11, color: 'var(--text3)', marginTop: 5 }}>Use the format "Team Name at Parent Firm" â€” this is how you'll appear in the database.</div>
                  </div>
                  <div className="ob-field">
                    <label className="ob-label">Legal entity name (if different)</label>
                    <input value={firmLegal} onChange={e => setFirmLegal(e.target.value)} placeholder="Optional" />
                  </div>
                  <div className="ob-field">
                    <label className="ob-label">Employment type</label>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: 7, marginTop: 4 }}>
                      {EMPLOYMENT_TYPES.map(et => (
                        <div key={et} className={'choice-card' + (employmentType === et ? ' selected' : '')}
                          style={{ padding: '12px 16px', gap: 12 }}
                          onClick={() => setEmploymentType(et)}>
                          <div className="choice-check" style={{ width: 16, height: 16 }}>{employmentType === et ? 'âœ“' : ''}</div>
                          <span style={{ fontSize: 13 }}>{et}</span>
                        </div>
                      ))}
                    </div>
                  </div>
                  <div style={{ marginBottom: 20 }}>
                    <div style={{ fontSize: 12, textTransform: 'uppercase', letterSpacing: '.08em', color: 'var(--accent)', fontWeight: 600, marginBottom: 12 }}>Address</div>
                    <div className="ob-grid-2" style={{ gap: 12, marginBottom: 12 }}>
                      <div className="ob-field" style={{ gridColumn: '1/-1', marginBottom: 0 }}>
                        <label className={'ob-label' + (errors.addr1 ? ' err' : '')}>Street address</label>
                        <input value={addr1} onChange={e => setAddr1(e.target.value)} placeholder="123 Main St" style={{ borderColor: errors.addr1 ? 'var(--red)' : '' }} />
                      </div>
                      <div className="ob-field" style={{ marginBottom: 0 }}>
                        <label className="ob-label">Suite / Unit</label>
                        <input value={addr2} onChange={e => setAddr2(e.target.value)} placeholder="Suite 400" />
                      </div>
                      <div className="ob-field" style={{ marginBottom: 0 }}>
                        <label className={'ob-label' + (errors.city ? ' err' : '')}>City <span className="req">*</span></label>
                        <input value={city} onChange={e => setCity(e.target.value)} style={{ borderColor: errors.city ? 'var(--red)' : '' }} />
                      </div>
                      <div className="ob-field" style={{ marginBottom: 0 }}>
                        <label className={'ob-label' + (errors.state ? ' err' : '')}>State <span className="req">*</span></label>
                        <select value={state} onChange={e => setState(e.target.value)} style={{ borderColor: errors.state ? 'var(--red)' : '' }}>
                          <option value="">Select...</option>
                          {'NH,VT,MA,ME,CT,RI,NY,NJ,PA,FL,TX,CA,IL,WA,CO,GA,NC,VA,OH,AZ,MN,WI,MO,OR,IN,MD,TN,MI,SC,KY,AL,LA,OK,UT,NV,MS,AR,KS,NM,NE,WV,ID,HI,DE,MT,WY,ND,SD,AK'.split(',').map(s => <option key={s}>{s}</option>)}
                        </select>
                      </div>
                      <div className="ob-field" style={{ marginBottom: 0 }}>
                        <label className={'ob-label' + (errors.zip ? ' err' : '')}>ZIP <span className="req">*</span></label>
                        <input value={zip} onChange={e => setZip(e.target.value)} placeholder="03101" style={{ borderColor: errors.zip ? 'var(--red)' : '' }} />
                      </div>
                    </div>
                  </div>
                  <div style={{ marginBottom: 20 }}>
                    <div style={{ fontSize: 12, textTransform: 'uppercase', letterSpacing: '.08em', color: 'var(--accent)', fontWeight: 600, marginBottom: 12 }}>Contact</div>
                    <div className="ob-grid-2" style={{ gap: 12 }}>
                      <div className="ob-field" style={{ marginBottom: 0 }}>
                        <label className="ob-label">Phone</label>
                        <input value={phone} onChange={e => setPhone(e.target.value)} placeholder="(603) 555-0100" />
                      </div>
                      <div className="ob-field" style={{ marginBottom: 0 }}>
                        <label className="ob-label">Website</label>
                        <input value={website} onChange={e => setWebsite(e.target.value)} placeholder="https://" />
                      </div>
                    </div>
                  </div>
                  <div style={{ marginBottom: 20 }}>
                    <div style={{ fontSize: 12, textTransform: 'uppercase', letterSpacing: '.08em', color: 'var(--accent)', fontWeight: 600, marginBottom: 12 }}>Assets & Clients <span style={{ color: 'var(--text3)', fontWeight: 400, textTransform: 'none', letterSpacing: 'normal', fontSize: 11 }}>self-reported, in $M</span></div>
                    <div className="ob-grid-3" style={{ gap: 12 }}>
                      <div className="ob-field" style={{ marginBottom: 0 }}>
                        <label className="ob-label">AUM ($M)</label>
                        <input type="number" value={selfAum} onChange={e => setSelfAum(e.target.value)} placeholder="e.g. 250" />
                      </div>
                      <div className="ob-field" style={{ marginBottom: 0 }}>
                        <label className="ob-label">Discretionary AUM ($M)</label>
                        <input type="number" value={selfAumDisc} onChange={e => setSelfAumDisc(e.target.value)} placeholder="e.g. 200" />
                      </div>
                      <div className="ob-field" style={{ marginBottom: 0 }}>
                        <label className="ob-label">Total accounts</label>
                        <input type="number" value={selfAccounts} onChange={e => setSelfAccounts(e.target.value)} placeholder="e.g. 180" />
                      </div>
                      <div className="ob-field" style={{ marginBottom: 0 }}>
                        <label className="ob-label">Individual clients</label>
                        <input type="number" value={selfIndClients} onChange={e => setSelfIndClients(e.target.value)} placeholder="e.g. 140" />
                      </div>
                      <div className="ob-field" style={{ marginBottom: 0 }}>
                        <label className="ob-label">HNW clients</label>
                        <input type="number" value={selfHNWClients} onChange={e => setSelfHNWClients(e.target.value)} placeholder="e.g. 60" />
                      </div>
                    </div>
                  </div>
                  <QuantFields intel={intel} setI={setI} setBoolI={setBoolI} setIntI={setIntI} toggleArr={toggleArr} errors={errors} />
                  <div style={{ marginBottom: 20 }}>
                    <div style={{ fontSize: 12, textTransform: 'uppercase', letterSpacing: '.08em', color: 'var(--accent)', fontWeight: 600, marginBottom: 12 }}>Services & Compensation</div>
                    <div className="ob-field">
                      <label className="ob-label">Services offered</label>
                      <Chips options={SERVICES_OPTS} selected={selectedServices} onToggle={v => toggleSvc(v, selectedServices, setSelectedServices)} />
                    </div>
                    <div className="ob-field">
                      <label className="ob-label">Compensation model</label>
                      <Chips options={COMP_OPTS} selected={selectedComp} onToggle={v => toggleSvc(v, selectedComp, setSelectedComp)} />
                    </div>
                  </div>
                </>
              )}
            </div>
          )}

          {/* PHASE 2 â€” Culture & Fit */}
          {phase === 2 && (
            <div key={animKey} className="ob-slide-in" style={{ flex: 1 }}>
              <div className="ob-phase-title">How do you work with clients?</div>
              <div className="ob-phase-sub">Culture and client approach are the most underweighted factors in M&A fit. This is what acquirers actually care about â€” and what makes one deal work while another falls apart.</div>
              <div style={{ background: 'var(--purple-dim)', border: '1px solid rgba(167,139,250,.2)', borderRadius: 10, padding: '12px 16px', marginBottom: 24, fontSize: 12, color: 'var(--text3)', lineHeight: 1.6 }}>
                ðŸ”’ <span style={{ color: 'var(--purple)', fontWeight: 600 }}>Private.</span> These answers are visible only to you and power goodness-of-fit matching. They are never shown to other firms or included in public data.
              </div>
              <div className="ob-field">
                <label className="ob-label">Primary client approach</label>
                <div style={{ fontSize: 11, color: 'var(--text3)', marginBottom: 8 }}>Select all that apply â€” most firms blend two or three.</div>
                <Chips options={CLIENT_APPROACH_OPTS} selected={intel.clientApproach || []} onToggle={v => toggleArr('clientApproach', v)} />
              </div>
              <div className="ob-field">
                <label className="ob-label">Client review cadence</label>
                <Chips options={REVIEW_OPTS} selected={intel.reviewCadence || []} onToggle={v => toggleArr('reviewCadence', v)} />
              </div>
              <div className="ob-field">
                <label className="ob-label">Do you review client tax returns?</label>
                <div style={{ display: 'flex', gap: 8 }}>
                  {['Yes, routinely','Yes, on request','No'].map(opt => (
                    <div key={opt} className={'chip' + (intel.reviewTaxReturns === opt ? ' on' : '')}
                      onClick={() => setI('reviewTaxReturns', intel.reviewTaxReturns === opt ? null : opt)}>
                      {opt}
                    </div>
                  ))}
                </div>
              </div>
              <div className="ob-field">
                <label className="ob-label">Office environment</label>
                <div style={{ display: 'flex', gap: 8 }}>
                  {['Remote-first','Hybrid','In-person first'].map(opt => (
                    <div key={opt} className={'chip' + (intel.officeEnvironment === opt ? ' on' : '')}
                      onClick={() => setI('officeEnvironment', intel.officeEnvironment === opt ? null : opt)}>
                      {opt}
                    </div>
                  ))}
                </div>
              </div>
              <div className="ob-field">
                <label className="ob-label">Culture traits</label>
                <div style={{ fontSize: 11, color: 'var(--text3)', marginBottom: 8 }}>What best describes your team's culture? Select all that apply.</div>
                <Chips options={CULTURE_OPTS} selected={intel.cultureTraits || []} onToggle={v => toggleArr('cultureTraits', v)} />
              </div>
              <div className="ob-field">
                <label className="ob-label">Briefly describe your office culture <span style={{ fontWeight: 400, textTransform: 'none', letterSpacing: 'normal', fontSize: 11 }}>(optional)</span></label>
                <textarea rows={3} value={intel.techNotes || ''} onChange={e => setI('cultureNotes', e.target.value)} placeholder="e.g. Close-knit team, we do a monthly lunch and an annual firm retreat. Partners are very accessible. Clients know everyone by name..." style={{ resize: 'vertical', lineHeight: 1.6 }} />
              </div>
            </div>
          )}

          {/* PHASE 3 â€” Operations & Technology */}
          {phase === 3 && (
            <div key={animKey} className="ob-slide-in" style={{ flex: 1 }}>
              <div className="ob-phase-title">Your tech stack & operations</div>
              <div className="ob-phase-sub">Technology compatibility is a real integration risk in acquisitions. Shared software platforms signal operational alignment â€” and mismatched stacks signal friction.</div>
              <div style={{ background: 'rgba(200,169,110,.08)', border: '1px solid rgba(200,169,110,.2)', borderRadius: 10, padding: '12px 16px', marginBottom: 24, fontSize: 12, color: 'var(--text3)', lineHeight: 1.6 }}>
                ðŸ”’ <span style={{ color: 'var(--accent)', fontWeight: 600 }}>Private.</span> Technology and operational data is never shared. It's used only in your private goodness-of-fit scoring.
              </div>
              <div className="ob-field">
                <label className="ob-label">CRM</label>
                <Chips options={CRM_OPTS} selected={intel.crm || []} onToggle={v => toggleArr('crm', v)} />
              </div>
              <div className="ob-field">
                <label className="ob-label">Financial planning software</label>
                <Chips options={FP_OPTS} selected={intel.financialPlanning || []} onToggle={v => toggleArr('financialPlanning', v)} />
              </div>
              <div className="ob-field">
                <label className="ob-label">Portfolio management / reporting</label>
                <Chips options={PMS_OPTS} selected={intel.portfolioMgmt || []} onToggle={v => toggleArr('portfolioMgmt', v)} />
              </div>
              <div className="ob-field">
                <label className="ob-label">Primary custodian(s)</label>
                <Chips options={CUSTODIANS} selected={intel.custodians || []} onToggle={v => toggleArr('custodians', v)} />
              </div>
              <div className="ob-field">
                <label className="ob-label">Other tools or notes <span style={{ fontWeight: 400, textTransform: 'none', letterSpacing: 'normal', fontSize: 11 }}>(optional)</span></label>
                <textarea rows={3} value={intel.techNotes || ''} onChange={e => setI('techNotes', e.target.value)} placeholder="e.g. We also use Holistiplan for tax planning, Nitrogen for risk, and HealthView for healthcare cost projections..." style={{ resize: 'vertical', lineHeight: 1.6 }} />
              </div>
            </div>
          )}

          {/* Footer nav */}
          <div className="ob-footer">
            <div className="ob-footer-hint">
              {phase === 3 ? 'All fields optional â€” add what you\'re comfortable with.' : ''}
            </div>
            <div className="ob-footer-btns">
              {canGoBack && (
                <button className="btn-ghost" onClick={() => goPhase(phase - 1)}>â† Back</button>
              )}
              <button className="btn-gold" onClick={handleNext} style={{ padding: '10px 28px', fontSize: 14 }}>
                {phase === PHASES.length - 1 ? 'Complete Profile âœ“' : 'Continue â†’'}
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

// Shared quantitative intelligence fields used in phase 1
function QuantFields({ intel, setI, setBoolI, setIntI, toggleArr, errors }) {
  return (
    <>
      <div style={{ marginBottom: 20 }}>
        <div style={{ fontSize: 12, textTransform: 'uppercase', letterSpacing: '.08em', color: 'var(--accent)', fontWeight: 600, marginBottom: 12 }}>Team Structure</div>
        <div className="ob-grid-3" style={{ gap: 12 }}>
          <div className="ob-field" style={{ marginBottom: 0 }}>
            <label className="ob-label">Total headcount</label>
            <input type="number" min="1" value={intel.teamSize ?? ''} onChange={e => setIntI('teamSize', e.target.value)} placeholder="e.g. 6" />
          </div>
          <div className="ob-field" style={{ marginBottom: 0 }}>
            <label className="ob-label">Advisors / producers</label>
            <input type="number" min="0" value={intel.numAdvisors ?? ''} onChange={e => setIntI('numAdvisors', e.target.value)} placeholder="e.g. 3" />
          </div>
          <div className="ob-field" style={{ marginBottom: 0 }}>
            <label className="ob-label">Support staff</label>
            <input type="number" min="0" value={intel.supportStaff ?? ''} onChange={e => setIntI('supportStaff', e.target.value)} placeholder="e.g. 2" />
          </div>
        </div>
      </div>
      <div style={{ marginBottom: 20 }}>
        <div style={{ fontSize: 12, textTransform: 'uppercase', letterSpacing: '.08em', color: 'var(--accent)', fontWeight: 600, marginBottom: 12 }}>Advisor Age Profile</div>
        <div style={{ fontSize: 11, color: 'var(--text3)', marginBottom: 10 }}>Check all age bands that apply to your producing advisors. This is the single biggest driver of succession vulnerability scoring.</div>
        <Chips options={['<40','40â€“49','50â€“59','60â€“64','65+']} selected={intel.advisorAgeBands || []} onToggle={v => toggleArr('advisorAgeBands', v)} />
      </div>
      <div style={{ marginBottom: 20 }}>
        <div style={{ fontSize: 12, textTransform: 'uppercase', letterSpacing: '.08em', color: 'var(--accent)', fontWeight: 600, marginBottom: 12 }}>Ownership & Succession</div>
        <div className="ob-grid-2" style={{ gap: 12 }}>
          <div className="ob-field" style={{ marginBottom: 0 }}>
            <label className="ob-label">Ownership structure</label>
            <select value={intel.ownershipStructure ?? ''} onChange={e => setI('ownershipStructure', e.target.value || null)}>
              <option value="">Select...</option>
              {['Solo owner','2 partners','3+ partners','Corporate owned'].map(o => <option key={o}>{o}</option>)}
            </select>
          </div>
          <div className="ob-field" style={{ marginBottom: 0 }}>
            <label className="ob-label">Succession timeline</label>
            <select value={intel.successionTimeline ?? ''} onChange={e => setI('successionTimeline', e.target.value || null)}>
              <option value="">Select...</option>
              {['None / not considering','5+ years','3â€“5 years','1â€“3 years','Actively exploring'].map(t => <option key={t}>{t}</option>)}
            </select>
          </div>
          <div className="ob-field" style={{ marginBottom: 0 }}>
            <label className="ob-label">Internal successor identified?</label>
            <select value={intel.internalSuccessorIdentified == null ? '' : String(intel.internalSuccessorIdentified)} onChange={e => setBoolI('internalSuccessorIdentified', e.target.value)}>
              <option value="">Select...</option><option value="true">Yes</option><option value="false">No</option>
            </select>
          </div>
          <div className="ob-field" style={{ marginBottom: 0 }}>
            <label className="ob-label">Open to minority capital?</label>
            <select value={intel.openToMinorityCapital == null ? '' : String(intel.openToMinorityCapital)} onChange={e => setBoolI('openToMinorityCapital', e.target.value)}>
              <option value="">Select...</option><option value="true">Yes</option><option value="false">No</option>
            </select>
          </div>
          <div className="ob-field" style={{ marginBottom: 0 }}>
            <label className="ob-label">Open to full sale?</label>
            <select value={intel.openToFullSale == null ? '' : String(intel.openToFullSale)} onChange={e => setBoolI('openToFullSale', e.target.value)}>
              <option value="">Select...</option><option value="true">Yes</option><option value="false">No</option>
            </select>
          </div>
        </div>
      </div>
      <div style={{ marginBottom: 20 }}>
        <div style={{ fontSize: 12, textTransform: 'uppercase', letterSpacing: '.08em', color: 'var(--accent)', fontWeight: 600, marginBottom: 12 }}>Growth Intent</div>
        <div className="ob-grid-2" style={{ gap: 12 }}>
          <div className="ob-field" style={{ marginBottom: 0 }}>
            <label className="ob-label">Growth intent</label>
            <select value={intel.growthIntent ?? ''} onChange={e => setI('growthIntent', e.target.value || null)}>
              <option value="">Select...</option>
              {['Organic only','Acquisitive','Strategic partnership','Undecided'].map(g => <option key={g}>{g}</option>)}
            </select>
          </div>
          <div className="ob-field" style={{ marginBottom: 0 }}>
            <label className="ob-label">Geographic flexibility</label>
            <select value={intel.geographicFlexibility ?? ''} onChange={e => setI('geographicFlexibility', e.target.value || null)}>
              <option value="">Select...</option>
              {['None â€” local only','Regional','National'].map(g => <option key={g}>{g}</option>)}
            </select>
          </div>
          <div className="ob-field" style={{ marginBottom: 0 }}>
            <label className="ob-label">Seeking acquisitions?</label>
            <select value={intel.seekingAcquisitions == null ? '' : String(intel.seekingAcquisitions)} onChange={e => setBoolI('seekingAcquisitions', e.target.value)}>
              <option value="">Select...</option><option value="true">Yes</option><option value="false">No</option>
            </select>
          </div>
          <div className="ob-field" style={{ marginBottom: 0 }}>
            <label className="ob-label">Hiring junior advisors?</label>
            <select value={intel.hiringJuniorAdvisors == null ? '' : String(intel.hiringJuniorAdvisors)} onChange={e => setBoolI('hiringJuniorAdvisors', e.target.value)}>
              <option value="">Select...</option><option value="true">Yes</option><option value="false">No</option>
            </select>
          </div>
        </div>
      </div>
    </>
  );
}

// =============================================================================
// MY PROFILE PAGE â€” Full rich profile view
// =============================================================================
function MyProfile({ profile, roa, onOpenOnboarding, onClearProfile, onSelect }) {
  const [matchMode, setMatchMode] = useState('acquire');

  if (!profile) {
    return (
      <div className="page" style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', minHeight: '60vh' }}>
        <div style={{ fontSize: 52, marginBottom: 20, opacity: .25 }}>â—Ž</div>
        <div style={{ fontFamily: 'Instrument Serif,serif', fontSize: 30, marginBottom: 10, color: 'var(--text2)', letterSpacing: '-.02em' }}>No profile yet</div>
        <div style={{ fontSize: 13, color: 'var(--text3)', maxWidth: 380, textAlign: 'center', lineHeight: 1.7, marginBottom: 24 }}>
          Create a profile to unlock full platform access, appear in the map and search, and run private intelligence matching.
        </div>
        <button className="btn-gold" style={{ padding: '11px 28px', fontSize: 14 }} onClick={onOpenOnboarding}>Create Profile â†’</button>
      </div>
    );
  }

  const intel = profile.intel || {};
  const successionScore  = calcSuccessionScore(intel);
  const acquisitionScore = calcAcquisitionScore(intel);
  const matches = useMemo(() => matchFirms(profile, roa, matchMode), [profile, roa, matchMode]);

  const claimedBase = profile.type === 'claimed' ? FIRMS.find(f => f.crd === profile.crd) : null;
  const aum      = profile.type === 'claimed' ? claimedBase?.aum      : profile.aum;
  const aumDisc  = profile.type === 'claimed' ? claimedBase?.aumDisc   : profile.aumDisc;
  const accounts = profile.type === 'claimed' ? claimedBase?.accounts  : profile.accounts;
  const employees = profile.type === 'claimed' ? claimedBase?.employees : intel.teamSize || null;
  const firmState = profile.type === 'claimed' ? claimedBase?.state : profile.state;

  const rankings = useMemo(() => {
    if (!aum) return null;
    const allWithAum = FIRMS.filter(f => f.aum > 0);
    const stateWithAum = allWithAum.filter(f => f.state === firmState);
    const nationalRankByAum = allWithAum.filter(f => f.aum < aum).length + 1;
    const stateRankByAum    = stateWithAum.filter(f => f.aum < aum).length + 1;
    const nationalPct       = Math.round((1 - (nationalRankByAum / allWithAum.length)) * 100);
    const statePct          = Math.round((1 - (stateRankByAum / stateWithAum.length)) * 100);
    const rev = aum * roa;
    const revPeers = allWithAum.filter(f => { const fr = f.aum * roa; return fr >= rev * 0.5 && fr <= rev * 2; });
    const stateBandPeers = stateWithAum.filter(f => f.aum >= aum * 0.5 && f.aum <= aum * 2);
    const empPct = employees && employees > 0
      ? Math.round((allWithAum.filter(f => (f.employees || 0) < employees).length / allWithAum.length) * 100)
      : null;
    return { nationalRank: nationalRankByAum, nationalTotal: allWithAum.length, nationalPct,
      stateRank: stateRankByAum, stateTotal: stateWithAum.length, statePct,
      revPeerCount: revPeers.length, stateBandPeerCount: stateBandPeers.length, empPct };
  }, [aum, roa, firmState, employees]);

  const MATCH_TIPS = {
    acquire: 'Firms scored on: geographic proximity, smaller AUM (<70% of yours), lean teams, and service/comp overlap.',
    partner: 'Similar-sized firms in complementary markets for strategic partnership.',
    sell:    'Larger RIAs with sufficient scale to be a credible acquirer or capital partner.',
  };

  const discPct = aum && aumDisc ? ((aumDisc / aum) * 100).toFixed(0) + '%' : null;

  return (
    <div className="page fade-up">
      {/* Hero */}
      <div className="profile-hero">
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', position: 'relative', zIndex: 1 }}>
          <div style={{ display: 'flex', gap: 20, alignItems: 'flex-start' }}>
            <div className="profile-avatar-lg">{(profile.firmName || '?')[0]}</div>
            <div>
              <div style={{ display: 'flex', alignItems: 'center', gap: 10, marginBottom: 5 }}>
                <div style={{ fontFamily: 'Instrument Serif,serif', fontSize: 28, letterSpacing: '-.03em', lineHeight: 1.1 }}>{profile.firmName}</div>
                <span className={'tag ' + (profile.type === 'claimed' ? 'tag-green' : 'tag-gold')}>
                  {profile.type === 'claimed' ? 'âœ“ Claimed RIA' : 'BD Team'}
                </span>
              </div>
              {profile.type === 'bd' && (
                <div style={{ fontSize: 12, color: 'var(--text3)', lineHeight: 1.6, marginBottom: 4 }}>
                  {profile.addr1}{profile.addr2 ? ', ' + profile.addr2 : ''}, {profile.city}, {profile.state} {profile.zip}
                </div>
              )}
              {profile.type === 'claimed' && claimedBase && (
                <div style={{ fontSize: 12, color: 'var(--text3)', marginBottom: 4 }}>{claimedBase.addr1}, {claimedBase.city}, {claimedBase.state}</div>
              )}
              {profile.employmentType && <div style={{ fontSize: 11, color: 'var(--text3)', marginBottom: 6 }}>{profile.employmentType}</div>}
              <div style={{ display: 'flex', gap: 12, fontSize: 12 }}>
                {(profile.phone || claimedBase?.phone) && <span style={{ color: 'var(--text3)' }}>{profile.phone || claimedBase.phone}</span>}
                {(profile.website || claimedBase?.website) && (() => { const wu2 = wu(profile.website || claimedBase?.website); return wu2 ? <a href={wu2} target="_blank" rel="noopener" style={{ color: 'var(--accent)', textDecoration: 'none' }}>Website â†—</a> : null; })()}
                {profile.type === 'claimed' && <a href={'https://adviserinfo.sec.gov/firm/summary/' + profile.crd} target="_blank" rel="noopener" style={{ color: 'var(--accent)', textDecoration: 'none' }}>IAPD â†—</a>}
              </div>
            </div>
          </div>
          <div style={{ display: 'flex', gap: 8, zIndex: 2 }}>
            <button className="btn-ghost btn-sm" onClick={onOpenOnboarding}>Edit Profile</button>
            <button className="btn-danger btn-sm" onClick={() => { if(confirm('Clear profile?')) onClearProfile(); }}>Clear</button>
          </div>
        </div>
      </div>

      {/* Key metrics */}
      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(5,1fr)', gap: 12, marginBottom: 20 }}>
        {[
          { label: 'AUM', value: fmtM(aum), sub: profile.type === 'claimed' ? 'From SEC ADV' : 'Self-reported', gold: true },
          { label: 'Discretionary', value: discPct || (aumDisc ? fmtM(aumDisc) : 'â€”'), sub: aumDisc ? fmtM(aumDisc) : 'Not reported' },
          { label: 'Est. Revenue', value: fmtM(aum ? aum * roa : null), sub: `at ${(roa*100).toFixed(2)}% ROA`, accent: true },
          { label: 'Accounts', value: fmtN(accounts) },
          { label: 'Team', value: intel.teamSize ? String(intel.teamSize) : (employees ? String(employees) : 'â€”'), sub: intel.numAdvisors ? `${intel.numAdvisors} advisor${intel.numAdvisors !== 1 ? 's' : ''}` : '' },
        ].map(m => (
          <div key={m.label} className="stat-card" style={{ borderColor: m.gold ? 'rgba(200,169,110,.35)' : m.accent ? 'rgba(200,169,110,.2)' : '' }}>
            <div className="stat-label">{m.label}</div>
            <div className={'stat-value' + (m.gold || m.accent ? ' metric-accent' : '')}>{m.value}</div>
            {m.sub && <div className="stat-sub">{m.sub}</div>}
          </div>
        ))}
      </div>

      {/* Rankings */}
      {rankings && (
        <div className="profile-section" style={{ marginBottom: 16 }}>
          <div className="profile-section-title">How You Compare <span style={{ color: 'var(--text3)', fontWeight: 400, textTransform: 'none', letterSpacing: 'normal', fontSize: 11 }}>by AUM vs. SEC-registered RIAs in database</span></div>
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4,1fr)', gap: 10 }}>
            <div className="rank-tile">
              <div className="rank-tile-label">National Rank (AUM)</div>
              <div className="rank-tile-value" style={{ color: 'var(--accent)' }}>#{rankings.nationalRank.toLocaleString()}</div>
              <div className="rank-tile-sub">of {rankings.nationalTotal.toLocaleString()} Â· top {100-rankings.nationalPct}%</div>
            </div>
            <div className="rank-tile">
              <div className="rank-tile-label">{firmState} State Rank</div>
              <div className="rank-tile-value" style={{ color: 'var(--accent)' }}>#{rankings.stateRank}</div>
              <div className="rank-tile-sub">of {rankings.stateTotal} in {firmState} Â· top {100-rankings.statePct}%</div>
            </div>
            <div className="rank-tile">
              <div className="rank-tile-label">Revenue-Band Peers</div>
              <div className="rank-tile-value">{rankings.revPeerCount.toLocaleString()}</div>
              <div className="rank-tile-sub">firms within 2Ã— your estimated revenue</div>
            </div>
            <div className="rank-tile">
              <div className="rank-tile-label">Size Peers in {firmState}</div>
              <div className="rank-tile-value">{rankings.stateBandPeerCount}</div>
              <div className="rank-tile-sub">similar-AUM RIAs in your state</div>
            </div>
          </div>
        </div>
      )}

      <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16, marginBottom: 16 }}>
        {/* Intelligence panel */}
        <div className="profile-section">
          <div className="profile-section-title">
            Intelligence Profile
            <span style={{ fontSize: 9, background: 'var(--purple-dim)', color: 'var(--purple)', padding: '2px 8px', borderRadius: 10, letterSpacing: '.05em' }}>PRIVATE</span>
          </div>
          {successionScore !== null && (
            <div style={{ marginBottom: 14 }}>
              <ScoreMeter score={successionScore} label="Succession Vulnerability"
                color={successionScore >= 70 ? 'var(--red)' : successionScore >= 40 ? 'var(--amber)' : 'var(--green)'} />
            </div>
          )}
          {acquisitionScore !== null && (
            <div style={{ marginBottom: 18 }}>
              <ScoreMeter score={acquisitionScore} label="Acquisition Appetite"
                color={acquisitionScore >= 60 ? 'var(--green)' : acquisitionScore >= 30 ? 'var(--accent)' : 'var(--text3)'} />
            </div>
          )}
          {/* Key intel rows */}
          {[
            ['Growth Intent', intel.growthIntent],
            ['Succession Timeline', intel.successionTimeline],
            ['Advisor Ages', intel.advisorAgeBands?.length ? intel.advisorAgeBands.join(', ') : null],
            ['Ownership', intel.ownershipStructure],
            ['Open to Sale', intel.openToFullSale != null ? (intel.openToFullSale ? 'Yes' : 'No') : null],
            ['Open to Minority Cap.', intel.openToMinorityCapital != null ? (intel.openToMinorityCapital ? 'Yes' : 'No') : null],
            ['Geographic Flex.', intel.geographicFlexibility],
            ['Hiring', intel.hiringJuniorAdvisors != null ? (intel.hiringJuniorAdvisors ? 'Yes' : 'No') : null],
          ].filter(([,v]) => v).map(([l,v]) => (
            <div key={l} className="detail-row">
              <span style={{ fontSize: 12, color: 'var(--text3)' }}>{l}</span>
              <span style={{ fontFamily: 'DM Mono,monospace', fontSize: 12 }}>{v}</span>
            </div>
          ))}

          {/* Culture section */}
          {(intel.clientApproach?.length > 0 || intel.cultureTraits?.length > 0 || intel.officeEnvironment) && (
            <div style={{ marginTop: 16, paddingTop: 12, borderTop: '1px solid var(--border)' }}>
              <div style={{ fontSize: 10, textTransform: 'uppercase', letterSpacing: '.1em', color: 'var(--accent)', fontWeight: 600, marginBottom: 10 }}>Culture & Fit</div>
              {intel.officeEnvironment && (
                <div style={{ marginBottom: 8 }}>
                  <span className="culture-pill">{intel.officeEnvironment}</span>
                  {intel.reviewTaxReturns && <span className="culture-pill">{intel.reviewTaxReturns === 'Yes, routinely' ? 'Reviews tax returns' : intel.reviewTaxReturns}</span>}
                </div>
              )}
              {intel.clientApproach?.length > 0 && (
                <div style={{ marginBottom: 8 }}>
                  {intel.clientApproach.map(c => <span key={c} className="culture-pill" style={{ borderColor: 'rgba(200,169,110,.3)', color: 'var(--accent)' }}>{c}</span>)}
                </div>
              )}
              {intel.cultureTraits?.length > 0 && (
                <div>{intel.cultureTraits.map(c => <span key={c} className="culture-pill">{c}</span>)}</div>
              )}
            </div>
          )}

          {/* Tech stack */}
          {(intel.crm?.length > 0 || intel.financialPlanning?.length > 0 || intel.portfolioMgmt?.length > 0 || intel.custodians?.length > 0) && (
            <div style={{ marginTop: 16, paddingTop: 12, borderTop: '1px solid var(--border)' }}>
              <div style={{ fontSize: 10, textTransform: 'uppercase', letterSpacing: '.1em', color: 'var(--accent)', fontWeight: 600, marginBottom: 10 }}>Operations & Tech</div>
              {intel.custodians?.length > 0 && <div style={{ marginBottom: 6 }}><span style={{ fontSize: 10, color: 'var(--text3)', marginRight: 6 }}>Custodians:</span>{intel.custodians.map(c => <span key={c} className="tag tag-dim" style={{ margin: '1px 3px' }}>{c}</span>)}</div>}
              {intel.crm?.length > 0 && <div style={{ marginBottom: 6 }}><span style={{ fontSize: 10, color: 'var(--text3)', marginRight: 6 }}>CRM:</span>{intel.crm.map(c => <span key={c} className="tag tag-dim" style={{ margin: '1px 3px' }}>{c}</span>)}</div>}
              {intel.financialPlanning?.length > 0 && <div style={{ marginBottom: 6 }}><span style={{ fontSize: 10, color: 'var(--text3)', marginRight: 6 }}>Planning:</span>{intel.financialPlanning.map(c => <span key={c} className="tag tag-dim" style={{ margin: '1px 3px' }}>{c}</span>)}</div>}
              {intel.portfolioMgmt?.length > 0 && <div><span style={{ fontSize: 10, color: 'var(--text3)', marginRight: 6 }}>Portfolio:</span>{intel.portfolioMgmt.map(c => <span key={c} className="tag tag-dim" style={{ margin: '1px 3px' }}>{c}</span>)}</div>}
            </div>
          )}
        </div>

        {/* Private matches */}
        <div className="profile-section">
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 8 }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
              <div className="profile-section-title" style={{ marginBottom: 0 }}>Private Matches</div>
              <span style={{ fontSize: 9, background: 'var(--purple-dim)', color: 'var(--purple)', padding: '2px 8px', borderRadius: 10, letterSpacing: '.05em' }}>PRIVATE</span>
              <span className="tt" style={{ fontSize: 11, color: 'var(--text3)', cursor: 'help' }}>â“˜<span className="tt-box" style={{ width: 260 }}>{MATCH_TIPS[matchMode]}</span></span>
            </div>
            <div style={{ display: 'flex', gap: 5 }}>
              {[['acquire','Acquire'],['partner','Partner'],['sell','Find Buyers']].map(([m,l]) => (
                <button key={m} className={matchMode === m ? 'btn-gold btn-sm' : 'btn-ghost btn-sm'}
                  style={{ fontSize: 11, padding: '4px 9px' }} onClick={() => setMatchMode(m)}>{l}</button>
              ))}
            </div>
          </div>
          <div style={{ fontSize: 11, color: 'var(--text3)', marginBottom: 14, lineHeight: 1.5 }}>
            {matchMode === 'acquire' && 'Firms that fit your acquisition profile â€” smaller, nearby, aligned.'}
            {matchMode === 'partner' && 'Similar-sized firms in complementary markets.'}
            {matchMode === 'sell' && 'Larger RIAs with scale to be a credible acquirer.'}
          </div>
          <div style={{ display: 'flex', flexDirection: 'column', gap: 8, maxHeight: 420, overflow: 'auto' }}>
            {matches.length === 0
              ? <div style={{ fontSize: 12, color: 'var(--text3)', padding: '20px 0', textAlign: 'center' }}>No strong matches â€” add more detail to your profile.</div>
              : matches.map((m, i) => (
                <div key={m.firm.crd} className="match-card" onClick={() => onSelect(m.firm)}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: 3 }}>
                    <div style={{ fontSize: 12, fontWeight: 600, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap', flex: 1, marginRight: 8 }}>{m.firm.name}</div>
                    <div className="match-score-pill" style={{ background: i < 3 ? 'var(--green-dim)' : 'var(--surface3)', color: i < 3 ? 'var(--green)' : 'var(--text3)', flexShrink: 0 }}>{m.score}</div>
                  </div>
                  <div style={{ fontSize: 11, color: 'var(--text3)', marginBottom: 5 }}>{m.firm.city}, {m.firm.state}</div>
                  <div style={{ fontFamily: 'DM Mono,monospace', fontSize: 11, display: 'flex', gap: 10 }}>
                    <span>{fmtM(m.firm.aum)}</span>
                    <span style={{ color: 'var(--accent)' }}>{fmtM(m.rev)} rev</span>
                    <span>{fmtN(m.firm.employees)} emp</span>
                  </div>
                </div>
              ))
            }
          </div>
        </div>
      </div>

      {/* Services for BD */}
      {profile.type === 'bd' && (profile.services?.length > 0 || profile.compensation?.length > 0) && (
        <div className="profile-section">
          <div className="profile-section-title">Services & Compensation</div>
          <div style={{ display: 'flex', gap: 24 }}>
            {profile.services?.length > 0 && <div><div style={{ fontSize: 11, color: 'var(--text3)', marginBottom: 6 }}>Services</div>{profile.services.map(s => <span key={s} className="tag tag-gold" style={{ margin: '2px' }}>{s}</span>)}</div>}
            {profile.compensation?.length > 0 && <div><div style={{ fontSize: 11, color: 'var(--text3)', marginBottom: 6 }}>Compensation</div>{profile.compensation.map(c => <span key={c} className="tag tag-dim" style={{ margin: '2px' }}>{c}</span>)}</div>}
          </div>
        </div>
      )}
    </div>
  );
}

// =============================================================================
// NAV
// =============================================================================
function Nav({ view, setView, savedCount, profile, onOpenOnboarding }) {
  const hasProfile = !!profile;
  const links = [
    ['dashboard', 'Overview'],
    ['explorer', 'Explorer'],
    ['detail', 'Firm Lookup'],
    ['saved', 'Targets' + (savedCount ? ` (${savedCount})` : '')],
    ['letter', 'Outreach'],
    ['myprofile', profile ? (profile.firmName.length > 18 ? profile.firmName.slice(0, 16) + 'â€¦' : profile.firmName) : 'My Profile'],
  ];
  return (
    <nav className="top-nav">
      <div className="nav-brand">
        <div className="logo-mark">RI</div>
        <span className="nav-brand-name">RIA Intelligence</span>
      </div>
      {links.map(([v, l]) => {
        const isLocked = !hasProfile && v !== 'myprofile';
        return (
          <span key={v}
            className={'nav-link' + (view === v ? ' active' : '') + (isLocked ? ' locked' : '') + (v === 'myprofile' ? ' ' : '')}
            style={v === 'myprofile' ? { color: view === v ? 'var(--accent)' : 'var(--accent)', opacity: 1 } : {}}
            onClick={() => isLocked ? null : setView(v)}
            title={isLocked ? 'Create a profile to unlock' : ''}
          >{l}</span>
        );
      })}
      <div className="nav-right">
        {!hasProfile
          ? <button className="btn-gold btn-sm" onClick={onOpenOnboarding}>Create Profile</button>
          : <span style={{ fontSize: 11, color: 'var(--text3)', background: 'var(--surface)', border: '1px solid var(--border)', borderRadius: 20, padding: '4px 12px' }}>
              NH Â· VT Â· MA Â· ME Â· <span style={{ color: 'var(--text2)' }}>{FIRMS.length.toLocaleString()} firms</span>
            </span>
        }
      </div>
    </nav>
  );
}

// =============================================================================
// MAP
// =============================================================================
function FirmMap({ firms, roa, rMin, rMax, onSelect, onBounds, userFirm }) {
  const ref = useRef(null), mRef = useRef(null), lRef = useRef(null);
  useEffect(() => {
    if (!ref.current || mRef.current) return;
    const m = L.map(ref.current, { center: [42.8, -71.4], zoom: 7, attributionControl: false });
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(m);
    mRef.current = m; lRef.current = L.layerGroup().addTo(m);
    const em = () => { const b = m.getBounds(); onBounds({ n: b.getNorth(), s: b.getSouth(), e: b.getEast(), w: b.getWest() }); };
    m.on('moveend', em); m.on('zoomend', em); setTimeout(em, 300);
    return () => { m.remove(); mRef.current = null; };
  }, []);
  useEffect(() => {
    if (!mRef.current || !lRef.current) return;
    lRef.current.clearLayers();
    window.__rvf = crd => { const f = FIRMS.find(x => x.crd === crd); if (f) onSelect(f); };

    // Render RIA firms
    firms.forEach(f => {
      const co = COORDS[f.crd]; if (!co) return;
      const rev = (f.aum || 0) * roa, hit = rev >= rMin && rev <= rMax;
      const br = Math.max(4, Math.min(11, Math.sqrt((f.aum || 0) / 1e8) * 2.5)), r = hit ? br + 5 : br;
      const c = L.circleMarker([co.lat, co.lng], { radius: r, fillColor: hit ? '#4ade80' : '#60a5fa', color: hit ? '#166534' : '#1d4ed8', weight: hit ? 2 : 1, opacity: hit ? .9 : .5, fillOpacity: hit ? .6 : .3 });
      c.bindPopup('<div style="min-width:200px"><div style="font-family:Instrument Serif,serif;font-size:14px;margin-bottom:2px">' + f.name + '</div><div style="color:#9aa0ad;font-size:11px;margin-bottom:8px">' + f.city + ', ' + f.state + '</div><div style="font-family:DM Mono,monospace;font-size:11px">RAUM&nbsp;<b>' + fmtM(f.aum) + '</b><br/>Rev&nbsp;&nbsp;<b style="color:' + (hit ? '#4ade80' : '#f0f1f3') + '">' + fmtM(rev) + '</b></div>' + (hit ? '<div style="margin-top:6px;font-size:10px;color:#4ade80;font-weight:600;text-transform:uppercase">In target range</div>' : '') + '<div onclick="window.__rvf(\'' + f.crd + '\')" class="pvb">View details â†’</div></div>', { className: 'mp' });
      lRef.current.addLayer(c);
    });

    // Render user's BD firm as a distinct gold star marker
    if (userFirm && userFirm.lat && userFirm.lng) {
      const starIcon = L.divIcon({
        html: '<div style="width:28px;height:28px;background:linear-gradient(135deg,#c8a96e,#7c5c2e);border-radius:50%;border:2px solid #c8a96e;display:flex;align-items:center;justify-content:center;font-size:14px;box-shadow:0 0 12px rgba(200,169,110,.6);line-height:28px;text-align:center">â˜…</div>',
        className: '',
        iconSize: [28, 28],
        iconAnchor: [14, 14],
      });
      const userMarker = L.marker([userFirm.lat, userFirm.lng], { icon: starIcon, zIndexOffset: 1000 });
      const userAum = userFirm.aum || null;
      userMarker.bindPopup('<div style="min-width:180px"><div style="display:flex;align-items:center;gap:6px;margin-bottom:4px"><span style="font-size:11px;background:rgba(200,169,110,.15);color:#c8a96e;border:1px solid rgba(200,169,110,.3);border-radius:10px;padding:2px 8px;font-weight:600">Your Firm</span></div><div style="font-family:Instrument Serif,serif;font-size:14px;margin-bottom:6px">' + userFirm.firmName + '</div><div style="color:#9aa0ad;font-size:11px;margin-bottom:8px">' + (userFirm.city || '') + (userFirm.state ? ', ' + userFirm.state : '') + '</div>' + (userAum ? '<div style="font-family:DM Mono,monospace;font-size:11px">RAUM&nbsp;<b style="color:#c8a96e">' + fmtM(userAum) + '</b></div>' : '') + '</div>', { className: 'mp' });
      lRef.current.addLayer(userMarker);
    }
  }, [firms, roa, rMin, rMax, userFirm]);
  return <div ref={ref} style={{ width: '100%', height: '100%', borderRadius: 10 }} />;
}

// =============================================================================
// DASHBOARD
// =============================================================================
function Dashboard({ roa, onSelect, saved, toggleSave, profile, onOpenOnboarding }) {
  const hasProfile = !!profile;
  const userFirm = useMemo(() => geocodeUserFirm(profile), [profile]);
  const ST = ['NH', 'VT', 'MA', 'ME'];
  const BUCKETS = [{ l: '< $100M', lo: 0, hi: 100e6 }, { l: '$100â€“250M', lo: 100e6, hi: 250e6 }, { l: '$250â€“500M', lo: 250e6, hi: 500e6 }, { l: '$500Mâ€“1B', lo: 500e6, hi: 1e9 }, { l: '$1â€“5B', lo: 1e9, hi: 5e9 }, { l: '$5â€“50B', lo: 5e9, hi: 50e9 }, { l: '$50B+', lo: 50e9, hi: Infinity }];
  const [fState, setFState] = useState(null);
  const [fBucket, setFBucket] = useState(null);
  const [aumCap, setAumCap] = useState(10e9);
  const capOpts = [{ l: 'No cap', v: Infinity }, { l: '$50B', v: 50e9 }, { l: '$10B', v: 10e9 }, { l: '$5B', v: 5e9 }, { l: '$1B', v: 1e9 }, { l: '$500M', v: 500e6 }, { l: '$250M', v: 250e6 }];
  const allFirms = useMemo(() => getFirmPool(profile), [profile]);
  const pool = useMemo(() => { let fs = allFirms.filter(f => f.aum > 0 && f.aum <= aumCap); if (fState) fs = fs.filter(f => f.state === fState); if (fBucket) fs = fs.filter(f => f.aum >= fBucket.lo && f.aum < fBucket.hi); return fs; }, [allFirms, fState, fBucket, aumCap]);
  const byState = useMemo(() => { const m = {}; ST.forEach(s => { const fs = pool.filter(f => f.state === s); const aums = fs.map(f => f.aum).sort((a, b) => a - b); const totAum = aums.reduce((s, a) => s + a, 0); m[s] = { count: fs.length, aum: totAum, rev: totAum * roa, med: aums.length ? aums[Math.floor(aums.length / 2)] : 0 }; }); return m; }, [pool, roa]);
  const totals = useMemo(() => { const a = pool.reduce((s, f) => s + f.aum, 0); return { firms: pool.length, aum: a, rev: a * roa, accounts: pool.reduce((s, f) => s + (f.accounts || 0), 0), employees: pool.reduce((s, f) => s + (f.employees || 0), 0) }; }, [pool, roa]);
  const dist = useMemo(() => { const base = allFirms.filter(f => f.aum > 0 && f.aum <= aumCap && (!fState || f.state === fState)); return BUCKETS.map(b => ({ ...b, count: base.filter(f => f.aum >= b.lo && f.aum < b.hi).length })); }, [allFirms, aumCap, fState]);
  const maxBucket = Math.max(...dist.map(d => d.count), 1);
  const top5 = arr => arr.slice(0, 5);
  const topAum = useMemo(() => top5([...pool].sort((a, b) => b.aum - a.aum)), [pool]);
  const topRev = useMemo(() => top5([...pool].sort((a, b) => b.aum * roa - a.aum * roa)), [pool, roa]);
  const topHNW = useMemo(() => top5([...pool].filter(f => f.clientsHNW > 0).sort((a, b) => b.clientsHNW - a.clientsHNW)), [pool]);
  const sweetSpot = useMemo(() => pool.filter(f => { const rev = f.aum * roa; return rev >= 500000 && rev <= 3000000 && f.employees >= 1 && f.employees <= 10; }).sort((a, b) => (b.aum * roa) - (a.aum * roa)), [pool, roa]);
  const hasFilter = fState || fBucket || aumCap !== 10e9;

  const Stat = ({ label, value, sub, gold, green }) => (
    <div className="stat-card" style={!hasProfile ? { filter: 'blur(0)' } : gold ? { borderColor: 'rgba(200,169,110,.35)' } : green ? { borderColor: 'rgba(74,222,128,.25)' } : {}}>
      <div className="stat-label">{label}</div>
      <div className={'stat-value' + (gold ? ' metric-accent' : green ? ' metric-green' : '')}>{hasProfile ? value : <BlurredCell>{value}</BlurredCell>}</div>
      {sub && <div className="stat-sub">{hasProfile ? sub : 'â€”'}</div>}
    </div>
  );

  const LB = ({ title, firms: lbF, valFn, sub }) => (
    <div className="card" style={{ padding: '18px 20px' }}>
      <div className="section-head">{title}</div>
      {lbF.map((f, i) => (
        <div key={f.crd} style={{ display: 'flex', alignItems: 'center', gap: 10, padding: '8px 0', borderBottom: i < lbF.length - 1 ? '1px solid var(--border)' : 'none', cursor: hasProfile ? 'pointer' : 'default', transition: 'opacity .15s' }}
          onClick={() => hasProfile && onSelect(f)}
          onMouseEnter={e => hasProfile && (e.currentTarget.style.opacity = '.75')}
          onMouseLeave={e => (e.currentTarget.style.opacity = '1')}>
          <div className="rank-badge" style={{ background: i === 0 ? 'var(--accent)' : i < 3 ? 'var(--surface3)' : 'transparent', border: i >= 3 ? '1px solid var(--border)' : 'none', color: i === 0 ? '#0e0f11' : 'var(--text3)' }}>{i + 1}</div>
          <div style={{ flex: 1, minWidth: 0 }}>
            <div style={{ fontSize: 12, fontWeight: 500, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>{f.name}</div>
            <div style={{ fontSize: 10, color: 'var(--text3)', marginTop: 1 }}>{f.city}, {f.state}{sub ? ' Â· ' + sub(f) : ''}</div>
          </div>
          <div style={{ fontSize: 12, fontFamily: 'DM Mono,monospace', fontWeight: 500, flexShrink: 0 }}>{hasProfile ? valFn(f) : <BlurredCell>{valFn(f)}</BlurredCell>}</div>
          {hasProfile && <StarBtn crd={f.crd} saved={saved} toggleSave={toggleSave} />}
        </div>
      ))}
    </div>
  );

  return (
    <div className="page fade-up">
      {!hasProfile && <GateBanner onOpenOnboarding={onOpenOnboarding} />}
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-end', marginBottom: 20 }}>
        <div>
          <div className="page-title">Advisory Landscape</div>
          <div className="page-sub">SEC Form ADV Â· Feb 2026 Â· ROA: {(roa * 100).toFixed(2)}%</div>
        </div>
        <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
          {hasFilter && <button className="btn-ghost btn-sm" onClick={() => { setFState(null); setFBucket(null); setAumCap(10e9); }} style={{ color: 'var(--accent)' }}>Clear filters</button>}
          <div className="filter-group"><label>AUM Cap</label>
            <select value={aumCap} onChange={e => setAumCap(+e.target.value)} style={{ width: 'auto', padding: '7px 12px' }}>
              {capOpts.map(c => <option key={c.l} value={c.v}>{c.l}</option>)}
            </select>
          </div>
        </div>
      </div>
      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(5,1fr)', gap: 12, marginBottom: 20 }}>
        <Stat label="Firms" value={totals.firms.toLocaleString()} />
        <Stat label="Total RAUM" value={fmtM(totals.aum)} gold />
        <Stat label="Est. Industry Rev" value={fmtM(totals.rev)} gold />
        <Stat label="Total Accounts" value={totals.accounts.toLocaleString()} />
        <Stat label="Employees" value={totals.employees.toLocaleString()} />
      </div>
      <div style={{ display: 'grid', gridTemplateColumns: '1.1fr 1fr', gap: 16, marginBottom: 16 }}>
        <div className="card" style={{ padding: '18px 20px' }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12 }}>
            <div className="section-head" style={{ marginBottom: 0 }}>Market by State</div>
            <span style={{ fontSize: 10, color: 'var(--text3)' }}>click to filter</span>
          </div>
          <table><thead><tr>
            <th style={{ background: 'transparent', position: 'static', padding: '6px 10px' }}>State</th>
            <th style={{ background: 'transparent', position: 'static', padding: '6px 10px', textAlign: 'right' }}>Firms</th>
            <th style={{ background: 'transparent', position: 'static', padding: '6px 10px', textAlign: 'right' }}>RAUM</th>
            <th style={{ background: 'transparent', position: 'static', padding: '6px 10px', textAlign: 'right', color: 'var(--accent)' }}>Est Rev</th>
            <th style={{ background: 'transparent', position: 'static', padding: '6px 10px', textAlign: 'right' }}>Median</th>
          </tr></thead><tbody>
            {ST.map(s => { const d = byState[s]; const active = fState === s; return (
              <tr key={s} onClick={() => setFState(active ? null : s)} style={{ cursor: 'pointer', borderLeft: active ? '2px solid var(--accent)' : '2px solid transparent' }}>
                <td style={{ padding: '9px 10px' }}><span className="tag tag-state">{s}</span></td>
                <td style={{ padding: '9px 10px', textAlign: 'right', fontFamily: 'DM Mono,monospace', fontSize: 12 }}>{d.count}</td>
                <td style={{ padding: '9px 10px', textAlign: 'right', fontFamily: 'DM Mono,monospace', fontSize: 12 }}>{hasProfile ? fmtM(d.aum) : <BlurredCell>{fmtM(d.aum)}</BlurredCell>}</td>
                <td style={{ padding: '9px 10px', textAlign: 'right', fontFamily: 'DM Mono,monospace', fontSize: 12, color: 'var(--accent)' }}>{hasProfile ? fmtM(d.rev) : <BlurredCell>{fmtM(d.rev)}</BlurredCell>}</td>
                <td style={{ padding: '9px 10px', textAlign: 'right', fontFamily: 'DM Mono,monospace', fontSize: 12, color: 'var(--text2)' }}>{hasProfile ? fmtM(d.med) : <BlurredCell>{fmtM(d.med)}</BlurredCell>}</td>
              </tr>
            ); })}
          </tbody></table>
        </div>
        <div className="card" style={{ padding: '18px 20px' }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12 }}>
            <div className="section-head" style={{ marginBottom: 0 }}>AUM Distribution</div>
            <span style={{ fontSize: 10, color: 'var(--text3)' }}>click to filter</span>
          </div>
          <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>
            {dist.map((d, i) => { const active = fBucket && fBucket.l === d.l; return (
              <div key={d.l} onClick={() => setFBucket(active ? null : BUCKETS[i])} style={{ display: 'flex', alignItems: 'center', gap: 10, cursor: 'pointer' }}>
                <span style={{ width: 76, fontSize: 11, color: active ? 'var(--accent)' : 'var(--text3)', textAlign: 'right', flexShrink: 0, fontWeight: active ? 600 : 400 }}>{d.l}</span>
                <div style={{ flex: 1, height: 18, background: 'var(--surface2)', borderRadius: 4, overflow: 'hidden' }}>
                  <div className="bar-fill" style={{ width: d.count > 0 ? (d.count / maxBucket * 100) + '%' : '0%', background: active ? 'var(--accent)' : 'linear-gradient(90deg,rgba(200,169,110,.6),rgba(200,169,110,.3))' }} />
                </div>
                <span style={{ fontFamily: 'DM Mono,monospace', fontSize: 11, width: 26, textAlign: 'right', color: active ? 'var(--accent)' : 'var(--text3)', flexShrink: 0 }}>{d.count}</span>
              </div>
            ); })}
          </div>
        </div>
      </div>
      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3,1fr)', gap: 16, marginBottom: 16 }}>
        <LB title="Top RAUM" firms={topAum} valFn={f => fmtM(f.aum)} sub={f => fmtN(f.employees) + ' emp'} />
        <LB title="Top Est. Revenue" firms={topRev} valFn={f => fmtM(f.aum * roa)} sub={f => fmtM(f.aum) + ' AUM'} />
        <LB title="Top HNW Clients" firms={topHNW} valFn={f => fmtN(f.clientsHNW) + ' HNW'} sub={f => fmtM(f.aumHNW) + ' HNW AUM'} />
      </div>
      {/* Sweet spot â€” locked if no profile */}
      <div className="card" style={{ padding: '18px 20px', position: 'relative' }}>
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 14 }}>
          <div>
            <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
              <div className="pulse" />
              <span style={{ fontSize: 13, fontWeight: 600, color: 'var(--green)' }}>Acquisition Sweet Spot</span>
              <span style={{ fontFamily: 'DM Mono,monospace', fontSize: 12, color: 'var(--green)', background: 'var(--green-dim)', padding: '2px 10px', borderRadius: 20 }}>{sweetSpot.length}</span>
            </div>
            <div style={{ fontSize: 11, color: 'var(--text3)', marginTop: 3 }}>$500Kâ€“$3M est. revenue Â· 1â€“10 employees</div>
          </div>
        </div>
        <div className={!hasProfile ? 'lock-overlay' : ''} style={{ maxHeight: hasProfile ? 'none' : 220, overflow: 'hidden' }}>
          <div className="table-scroll"><table><thead><tr>
            <th>Firm</th><th>St</th><th>City</th>
            <th style={{ textAlign: 'right' }}>RAUM</th>
            <th style={{ textAlign: 'right', color: 'var(--green)' }}>Est Rev</th>
            <th style={{ textAlign: 'right' }}>Emp</th>
            <th style={{ textAlign: 'right' }}>Accts</th>
            {hasProfile && <th style={{ textAlign: 'center', width: 36 }}>â˜…</th>}
          </tr></thead><tbody>
            {sweetSpot.slice(0, hasProfile ? 25 : 5).map(f => {
              const rev = f.aum * roa;
              return (
                <tr key={f.crd} className="ss-row" onClick={() => hasProfile && onSelect(f)}>
                  <td style={{ fontWeight: 500, maxWidth: 240, overflow: 'hidden', textOverflow: 'ellipsis' }}>{f.name}</td>
                  <td><span className="tag tag-state">{f.state}</span></td>
                  <td style={{ color: 'var(--text2)' }}>{f.city}</td>
                  <td style={{ textAlign: 'right' }} className="mono">{hasProfile ? fmtM(f.aum) : <BlurredCell>{fmtM(f.aum)}</BlurredCell>}</td>
                  <td style={{ textAlign: 'right', color: 'var(--green)', fontWeight: 500 }} className="mono">{hasProfile ? fmtM(rev) : <BlurredCell>{fmtM(rev)}</BlurredCell>}</td>
                  <td style={{ textAlign: 'right' }} className="mono">{hasProfile ? fmtN(f.employees) : <BlurredCell>{fmtN(f.employees)}</BlurredCell>}</td>
                  <td style={{ textAlign: 'right' }} className="mono">{hasProfile ? fmtN(f.accounts) : <BlurredCell>{fmtN(f.accounts)}</BlurredCell>}</td>
                  {hasProfile && <td style={{ textAlign: 'center' }} onClick={e => e.stopPropagation()}><StarBtn crd={f.crd} saved={saved} toggleSave={toggleSave} /></td>}
                </tr>
              );
            })}
          </tbody></table></div>
        </div>
        {!hasProfile && (
          <div style={{ position: 'absolute', bottom: 24, left: 0, right: 0, display: 'flex', justifyContent: 'center' }}>
            <button className="btn-gold" onClick={onOpenOnboarding}>Create Profile to unlock all {sweetSpot.length} firms â†’</button>
          </div>
        )}
      </div>
    </div>
  );
}

// =============================================================================
// EXPLORER (locked version when no profile)
// =============================================================================
function Explorer({ roa, setRoa, onSelect, saved, toggleSave, profile, onOpenOnboarding }) {
  const hasProfile = !!profile;
  const userFirm = useMemo(() => geocodeUserFirm(profile), [profile]);
  const [search, setSearch] = useState('');
  const [stF, setStF] = useState('ALL');
  const [rMin, setRMin] = useState(1000000);
  const [rMax, setRMax] = useState(2000000);
  const [sCol, setSCol] = useState('aum');
  const [sDir, setSDir] = useState('desc');
  const [tOnly, setTOnly] = useState(false);
  const [showMap, setShowMap] = useState(true);
  const [bounds, setBounds] = useState(null);
  const [fByMap, setFByMap] = useState(false);

  const allFirms = useMemo(() => getFirmPool(profile), [profile]);
  const base = useMemo(() => allFirms.filter(f => {
    if (stF !== 'ALL' && f.state !== stF) return false;
    if (search && !f.name.toLowerCase().includes(search.toLowerCase()) && !f.city.toLowerCase().includes(search.toLowerCase())) return false;
    if (tOnly) { const r = (f.aum || 0) * roa; if (r < rMin || r > rMax) return false; }
    return true;
  }), [search, stF, roa, rMin, rMax, tOnly]);

  const filtered = useMemo(() => {
    let fl = base;
    if (fByMap && bounds) fl = fl.filter(f => { const co = COORDS[f.crd]; if (!co) return false; return co.lat >= bounds.s && co.lat <= bounds.n && co.lng >= bounds.w && co.lng <= bounds.e; });
    return [...fl].sort((a, b) => { let va = a[sCol], vb = b[sCol]; if (sCol === 'estRev') { va = (a.aum || 0) * roa; vb = (b.aum || 0) * roa; } if (va == null) va = sDir === 'desc' ? -Infinity : Infinity; if (vb == null) vb = sDir === 'desc' ? -Infinity : Infinity; if (typeof va === 'string') return sDir === 'desc' ? vb.localeCompare(va) : va.localeCompare(vb); return sDir === 'desc' ? vb - va : va - vb; });
  }, [base, fByMap, bounds, sCol, sDir, roa]);

  const tog = c => { if (sCol === c) setSDir(d => d === 'desc' ? 'asc' : 'desc'); else { setSCol(c); setSDir('desc'); } };
  const arr = c => sCol === c ? (sDir === 'desc' ? ' â–¾' : ' â–´') : '';

  return (
    <div className="page fade-up">
      {!hasProfile && <GateBanner onOpenOnboarding={onOpenOnboarding} />}
      <div style={{ marginBottom: 16 }}>
        <div className="page-title">Firm Explorer</div>
        <div className="page-sub">SEC-registered RIAs Â· NH / VT / MA / ME</div>
      </div>
      <div className="card" style={{ padding: '16px 20px', marginBottom: 16 }}>
        <div className="filter-bar">
          <div className="filter-group" style={{ flex: '1 1 180px' }}><label>Search</label><input value={search} onChange={e => setSearch(e.target.value)} placeholder="Firm name or cityâ€¦" /></div>
          <div className="filter-group"><label>State</label><select value={stF} onChange={e => setStF(e.target.value)} style={{ width: 90 }}><option value="ALL">All</option><option>NH</option><option>VT</option><option>MA</option><option>ME</option></select></div>
          {hasProfile && <>
            <div className="filter-group"><label>ROA %</label><input type="number" value={(roa * 100).toFixed(2)} onChange={e => setRoa(parseFloat(e.target.value) / 100 || .0065)} step="0.05" style={{ width: 90, textAlign: 'center' }} /></div>
            <div className="filter-group"><label>Rev Min</label><input type="number" value={rMin} onChange={e => setRMin(+e.target.value)} step={100000} style={{ width: 130 }} /></div>
            <div className="filter-group"><label>Rev Max</label><input type="number" value={rMax} onChange={e => setRMax(+e.target.value)} step={100000} style={{ width: 130 }} /></div>
            <div style={{ display: 'flex', gap: 8, alignSelf: 'flex-end' }}>
              <button onClick={() => setTOnly(!tOnly)} className={tOnly ? 'btn-gold btn-sm' : 'btn-ghost btn-sm'}>{tOnly ? 'Targets only' : 'Show all'}</button>
              <button onClick={() => setShowMap(!showMap)} className="btn-ghost btn-sm" style={showMap ? { borderColor: 'var(--accent)', color: 'var(--accent)' } : {}}>{showMap ? 'Hide map' : 'Show map'}</button>
            </div>
          </>}
        </div>
      </div>

      {showMap && hasProfile && (
        <div style={{ marginBottom: 16 }}>
          <div className="card" style={{ height: 380, padding: 0, overflow: 'hidden' }}>
            <FirmMap firms={base} roa={roa} rMin={rMin} rMax={rMax} onSelect={onSelect} onBounds={setBounds} userFirm={userFirm} />
          </div>
          <div style={{ display: 'flex', alignItems: 'center', gap: 10, marginTop: 8 }}>
            <button onClick={() => setFByMap(!fByMap)} className={fByMap ? 'btn-gold btn-sm' : 'btn-ghost btn-sm'}>{fByMap ? 'âœ“ Filtering by map' : 'Filter by map view'}</button>
            <span style={{ fontSize: 11, color: 'var(--text3)', display: 'flex', gap: 12, marginLeft: 'auto' }}>
              <span><span style={{ display: 'inline-block', width: 9, height: 9, borderRadius: '50%', background: '#4ade80', marginRight: 5, verticalAlign: 'middle' }} />Target range</span>
              <span><span style={{ display: 'inline-block', width: 7, height: 7, borderRadius: '50%', background: '#60a5fa', marginRight: 5, verticalAlign: 'middle' }} />Other</span>
              {userFirm && <span><span style={{ marginRight: 5 }}>â˜…</span><span style={{ color: 'var(--accent)' }}>Your firm</span></span>}
            </span>
          </div>
        </div>
      )}

      <div className="card table-scroll">
        <table><thead><tr>
          <th onClick={() => tog('name')}>Firm{arr('name')}</th>
          <th>St</th><th>City</th>
          <th onClick={() => tog('aum')} style={{ textAlign: 'right' }}>RAUM{arr('aum')}</th>
          {hasProfile && <>
            <th onClick={() => tog('estRev')} style={{ textAlign: 'right', color: 'var(--accent)' }}>Est Rev{arr('estRev')}</th>
            <th style={{ textAlign: 'center' }}>Target</th>
            <th onClick={() => tog('accounts')} style={{ textAlign: 'right' }}>Accts{arr('accounts')}</th>
            <th onClick={() => tog('clientsHNW')} style={{ textAlign: 'right' }}>HNW{arr('clientsHNW')}</th>
            <th onClick={() => tog('employees')} style={{ textAlign: 'right' }}>Emp{arr('employees')}</th>
            <th style={{ textAlign: 'center', width: 60 }}>Detail</th>
            <th style={{ textAlign: 'center', width: 40 }}>â˜…</th>
          </>}
        </tr></thead><tbody>
          {filtered.slice(0, hasProfile ? filtered.length : 15).map((f, i) => {
            const rev = (f.aum || 0) * roa, hit = rev >= rMin && rev <= rMax;
            return (
              <tr key={f.crd + i} className={hit && hasProfile ? 'highlight-row' : ''} style={{ cursor: hasProfile ? 'pointer' : 'default' }} onClick={() => hasProfile && onSelect(f)}>
                <td style={{ fontWeight: 500, maxWidth: 260, overflow: 'hidden', textOverflow: 'ellipsis' }}>{f.name}</td>
                <td><span className="tag tag-state">{f.state}</span></td>
                <td style={{ color: 'var(--text2)' }}>{f.city}</td>
                <td style={{ textAlign: 'right' }} className="mono">{hasProfile ? fmtM(f.aum) : <BlurredCell>{fmtM(f.aum)}</BlurredCell>}</td>
                {hasProfile && <>
                  <td style={{ textAlign: 'right', color: hit ? 'var(--green)' : 'var(--accent)', fontWeight: 500 }} className="mono">{fmtM(rev)}</td>
                  <td style={{ textAlign: 'center' }}>{hit ? <span className="tag tag-green">Yes</span> : ''}</td>
                  <td style={{ textAlign: 'right' }} className="mono">{fmtN(f.accounts)}</td>
                  <td style={{ textAlign: 'right' }} className="mono">{fmtN(f.clientsHNW)}</td>
                  <td style={{ textAlign: 'right' }} className="mono">{fmtN(f.employees)}</td>
                  <td style={{ textAlign: 'center' }} onClick={e => e.stopPropagation()}><button className="btn-ghost btn-sm" onClick={() => onSelect(f)}>View</button></td>
                  <td style={{ textAlign: 'center' }} onClick={e => e.stopPropagation()}><StarBtn crd={f.crd} saved={saved} toggleSave={toggleSave} /></td>
                </>}
              </tr>
            );
          })}
          {!hasProfile && (
            <tr>
              <td colSpan={4} style={{ textAlign: 'center', padding: '18px', color: 'var(--text3)', fontSize: 12 }}>
                <button className="btn-gold btn-sm" onClick={onOpenOnboarding}>Create a profile to see full data for all {FIRMS.length.toLocaleString()} firms â†’</button>
              </td>
            </tr>
          )}
        </tbody></table>
      </div>
    </div>
  );
}

// =============================================================================
// FIRM DETAIL (locked if no profile)
// =============================================================================
function FirmDetail({ firm, setFirm, onLetter, roa, saved, toggleSave, profile, onOpenOnboarding }) {
  const hasProfile = !!profile;
  const [animKey, setAnimKey] = useState(0);
  useEffect(() => { if (firm) setAnimKey(k => k + 1); }, [firm?.crd]);

  if (!firm) return (
    <div className="page" style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', minHeight: '60vh' }}>
      {!hasProfile && <GateBanner onOpenOnboarding={onOpenOnboarding} />}
      <div style={{ fontSize: 11, letterSpacing: '.1em', textTransform: 'uppercase', color: 'var(--text3)', marginBottom: 16 }}>Firm Lookup</div>
      <div className="serif" style={{ fontSize: 36, marginBottom: 24, color: 'var(--text2)' }}>{hasProfile ? 'Select a firm to explore' : 'Create a profile to access firm data'}</div>
      {hasProfile
        ? <select onChange={e => { const f = FIRMS.find(x => x.crd === e.target.value); if (f) setFirm(f); }} style={{ width: 380, padding: 12, fontSize: 14 }}>
            <option value="">Choose a firmâ€¦</option>
            {FIRMS.slice().sort((a, b) => a.name.localeCompare(b.name)).map(f => <option key={f.crd} value={f.crd}>{f.name} ({f.state})</option>)}
          </select>
        : <button className="btn-gold" onClick={onOpenOnboarding}>Create Profile â†’</button>
      }
    </div>
  );

  const rev = (firm.aum || 0) * roa;
  const avg = firm.accounts > 0 ? firm.aum / firm.accounts : null;
  const rpe = firm.employees > 0 ? rev / firm.employees : null;
  const pctD = firm.aum > 0 && firm.aumDisc ? (firm.aumDisc / firm.aum * 100).toFixed(1) + '%' : '-';
  const wurl = wu(firm.website);

  const Row = ({ label, value, money, green, accent }) => (
    <div className="detail-row">
      <span className="detail-label">{label}</span>
      <span className={'detail-value' + (green ? ' metric-green' : accent ? ' metric-accent' : '')} style={green ? { color: 'var(--green)' } : accent ? { color: 'var(--accent)' } : {}}>
        {money ? fmt(value) : value != null ? value : '-'}
      </span>
    </div>
  );
  const Section = ({ title, children }) => (<div style={{ marginBottom: 20 }}><div className="section-head">{title}</div>{children}</div>);

  return (
    <div className="page">
      <div key={animKey} className="fade-up" style={{ marginBottom: 28 }}>
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', flexWrap: 'wrap', gap: 16 }}>
          <div style={{ flex: 1, minWidth: 0 }}>
            <div style={{ fontSize: 11, letterSpacing: '.1em', textTransform: 'uppercase', color: 'var(--text3)', marginBottom: 8, display: 'flex', alignItems: 'center', gap: 8 }}>
              CRD #{firm.crd} Â· <span className="tag tag-state" style={{ fontSize: 10 }}>{firm.state}</span>
            </div>
            <div style={{ fontFamily: 'Instrument Serif,serif', fontSize: 36, letterSpacing: '-.02em', lineHeight: 1.1, marginBottom: 10 }}>{firm.name}</div>
            <div style={{ fontSize: 12, color: 'var(--text3)', marginBottom: 8 }}>{firm.addr1}{firm.addr2 ? ', ' + firm.addr2 : ''}, {firm.city}, {firm.state} {firm.zip}</div>
            <div style={{ display: 'flex', gap: 16, fontSize: 12 }}>
              {firm.phone && <span style={{ color: 'var(--text2)' }}>{firm.phone}</span>}
              {wurl && <a href={wurl} target="_blank" rel="noopener" style={{ color: 'var(--accent)', textDecoration: 'none' }}>Website â†—</a>}
              <a href={'https://adviserinfo.sec.gov/firm/summary/' + firm.crd} target="_blank" rel="noopener" style={{ color: 'var(--accent)', textDecoration: 'none' }}>IAPD â†—</a>
            </div>
          </div>
          <div style={{ display: 'flex', gap: 8, flexShrink: 0 }}>
            <StarBtn crd={firm.crd} saved={saved} toggleSave={toggleSave} />
            <button className="btn-ghost" onClick={() => onLetter(firm)}>âœ‰ Write Letter</button>
            <button className="btn-gold" onClick={() => onLetter(firm)}>Generate Prompt</button>
          </div>
        </div>
      </div>

      <div key={animKey + 'm'} className="fade-up" style={{ animationDelay: '.05s', display: 'grid', gridTemplateColumns: 'repeat(4,1fr)', gap: 12, marginBottom: 24 }}>
        <div className="stat-card"><div className="stat-label">Total RAUM</div><div className="stat-value">{fmtM(firm.aum)}</div><div className="stat-sub">{pctD} discretionary</div></div>
        <div className="stat-card" style={{ borderColor: 'rgba(200,169,110,.3)' }}><div className="stat-label" style={{ color: 'var(--accent)' }}>Est. Revenue</div><div className="stat-value metric-accent">{fmtM(rev)}</div><div className="stat-sub">at {(roa * 100).toFixed(2)}% ROA</div></div>
        <div className="stat-card"><div className="stat-label">Accounts</div><div className="stat-value">{fmtN(firm.accounts)}</div>{avg && <div className="stat-sub">{fmtM(avg)} avg size</div>}</div>
        <div className="stat-card"><div className="stat-label">Employees</div><div className="stat-value">{fmtN(firm.employees)}</div>{rpe && <div className="stat-sub">{fmtM(rpe)} rev/emp</div>}</div>
      </div>

      <div key={animKey + 'd'} className="fade-up" style={{ animationDelay: '.1s', display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16 }}>
        <div className="detail-panel">
          <Section title="Assets Under Management">
            <Row label="Total RAUM" value={firm.aum} money accent /><Row label="Discretionary" value={firm.aumDisc} money /><Row label="Non-Discretionary" value={firm.aumNonDisc} money /><Row label="% Discretionary" value={pctD} /><Row label="Avg Account Size" value={avg} money />
          </Section>
          <Section title="Revenue"><Row label="Est. Revenue" value={rev} money green /><Row label="Rev per Employee" value={rpe} money /></Section>
          <Section title="Clients">
            <Row label="Individual" value={fmtN(firm.clientsInd)} /><Row label="Individual AUM" value={firm.aumInd} money /><Row label="HNW" value={fmtN(firm.clientsHNW)} /><Row label="HNW AUM" value={firm.aumHNW} money /><Row label="Pension" value={fmtN(firm.clientsPension)} /><Row label="Charitable" value={fmtN(firm.clientsCharitable)} /><Row label="Corp/Business" value={fmtN(firm.clientsCorp)} />
          </Section>
        </div>
        <div>
          <div className="detail-panel" style={{ marginBottom: 14 }}>
            <Section title="Services & Compensation">
              <div style={{ marginBottom: 10 }}>{firm.services.map(s => <span key={s} className="tag tag-gold" style={{ margin: '2px' }}>{s}</span>)}</div>
              <div>{firm.compensation.map(c => <span key={c} className="tag tag-dim" style={{ margin: '2px' }}>{c}</span>)}</div>
            </Section>
            <Section title="Firm Profile">
              <Row label="Org Type" value={firm.orgType} /><Row label="SEC Status" value={firm.secStatus} /><Row label="Status Date" value={firm.statusDate} /><Row label="Latest ADV" value={firm.advDate} /><Row label="Other Offices" value={fmtN(firm.otherOffices)} />
            </Section>
            <Section title="Affiliations">
              <Row label="BD Affiliate" value={firm.bdAffiliate ? 'Yes' : 'No'} /><Row label="IA Affiliate" value={firm.iaAffiliate ? 'Yes' : 'No'} /><Row label="Custody" value={firm.custody ? 'Yes' : 'No'} /><Row label="Disclosures" value={firm.disclosures ? 'Yes' : 'No'} /><Row label="Wrap Fee" value={firm.wrapFee ? 'Yes' : 'No'} />
            </Section>
          </div>
        </div>
      </div>
    </div>
  );
}

// =============================================================================
// LETTER WRITER
// =============================================================================
function LetterWriter({ firm, setFirm, roa, profile, onOpenOnboarding, crm, setCrmAndSave }) {
  const hasProfile = !!profile;

  // Sender info
  const [sN, setSN] = useState('');
  const [sT, setST] = useState('');
  const [sF, setSF] = useState(profile?.firmName || '');
  const [sA, setSA] = useState(profile ? [profile.addr1, profile.city, profile.state, profile.zip].filter(Boolean).join(', ') : '');
  const [settOpen, setSettOpen] = useState(false);

  // Campaign settings (per-firm, but defaults here)
  const [purpose, setP] = useState('acquisition');
  const [aggressiveness, setAgg] = useState('active');
  const [ctx, setCtx] = useState('');

  // Active touch being viewed/prompted
  const [activeTouchNum, setActiveTouchNum] = useState(null);
  const [prompt, setPrompt] = useState('');
  const [copied, setCopied] = useState(false);

  // Log-sent modal
  const [showLogModal, setShowLogModal] = useState(false);
  const [logNotes, setLogNotes] = useState('');

  // CRM view toggle
  const [crmView, setCrmView] = useState('compose'); // 'compose' | 'pipeline'

  const firmCrm = firm ? (crm[firm.crd] || null) : null;
  const sequence = CADENCE_SEQUENCES[firmCrm?.aggressiveness || aggressiveness] || [];
  const sentTouches = firmCrm?.touches || [];
  const nextTouchNum = sentTouches.length > 0 ? Math.max(...sentTouches.map(t => t.touchNum)) + 1 : 1;
  const nextTouch = sequence.find(t => t.touchNum === nextTouchNum) || null;
  const activeTouch = sequence.find(t => t.touchNum === activeTouchNum) || nextTouch;

  // All contacted firms
  const contactedFirms = useMemo(() => {
    return Object.values(crm)
      .filter(c => c.touches && c.touches.length > 0)
      .sort((a, b) => {
        const aLast = a.touches[a.touches.length - 1]?.sentAt || '';
        const bLast = b.touches[b.touches.length - 1]?.sentAt || '';
        return bLast.localeCompare(aLast);
      });
  }, [crm]);

  const generatePrompt = (touchOverride) => {
    if (!firm) return;
    const touch = touchOverride || activeTouch;
    if (!touch || touch.type === 'pause') return;
    const p = buildTouchPrompt({
      touch, firm, roa, profile, purpose: firmCrm?.purpose || purpose,
      aggressiveness: firmCrm?.aggressiveness || aggressiveness,
      prevTouches: sentTouches, ctx, sN, sT, sF, sA,
    });
    setPrompt(p);
    setActiveTouchNum(touch.touchNum);
  };

  const initCampaign = () => {
    if (!firm) return;
    const record = {
      crd: firm.crd,
      firmName: firm.name,
      firmCity: firm.city,
      firmState: firm.state,
      firmAum: firm.aum,
      purpose: purpose,
      aggressiveness: aggressiveness,
      touches: [],
      createdAt: new Date().toISOString(),
    };
    const updated = { ...crm, [firm.crd]: record };
    setCrmAndSave(updated);
  };

  const logTouch = () => {
    if (!firm || !activeTouch) return;
    const touch = activeTouch;
    const record = crm[firm.crd] || {
      crd: firm.crd, firmName: firm.name, firmCity: firm.city, firmState: firm.state,
      firmAum: firm.aum, purpose: firmCrm?.purpose || purpose,
      aggressiveness: firmCrm?.aggressiveness || aggressiveness,
      touches: [], createdAt: new Date().toISOString(),
    };
    const newTouch = { touchNum: touch.touchNum, type: touch.type, label: touch.label, sentAt: new Date().toISOString(), notes: logNotes.trim() };
    const updated = { ...crm, [firm.crd]: { ...record, touches: [...record.touches, newTouch] } };
    setCrmAndSave(updated);
    setLogNotes('');
    setShowLogModal(false);
    // Advance to next touch
    const nextNum = touch.touchNum + 1;
    setActiveTouchNum(nextNum);
    setPrompt('');
  };

  const removeCampaign = (crd) => {
    const updated = { ...crm };
    delete updated[crd];
    setCrmAndSave(updated);
    if (firm?.crd === crd) setPrompt('');
  };

  const daysUntilNext = (record) => {
    if (!record?.touches?.length) return null;
    const lastTouch = record.touches[record.touches.length - 1];
    const seq = CADENCE_SEQUENCES[record.aggressiveness] || [];
    const nextT = seq.find(t => t.touchNum === lastTouch.touchNum + 1);
    if (!nextT || nextT.type === 'pause') return nextT ? nextT.daysAfterPrev : null;
    const lastDate = new Date(lastTouch.sentAt);
    const targetDate = new Date(lastDate.getTime() + nextT.daysAfterPrev * 86400000);
    const diff = Math.round((targetDate - new Date()) / 86400000);
    return diff;
  };

  if (!hasProfile) return (
    <div className="page" style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', minHeight: '60vh' }}>
      <GateBanner onOpenOnboarding={onOpenOnboarding} />
    </div>
  );

  const AGG_OPTS = [
    { v: 'measured',   label: 'Measured',   desc: '5 touches over ~6 months' },
    { v: 'active',     label: 'Active',     desc: '7 touches over ~4 months' },
    { v: 'persistent', label: 'Persistent', desc: '9 touches over ~3 months' },
  ];

  return (
    <div className="page fade-up">
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-end', marginBottom: 20 }}>
        <div>
          <div className="page-title">Outreach CRM</div>
          <div className="page-sub">Manage cadences, generate prompts, track contacts</div>
        </div>
        <div style={{ display: 'flex', gap: 8 }}>
          <button className={crmView === 'compose' ? 'btn-gold btn-sm' : 'btn-ghost btn-sm'} onClick={() => setCrmView('compose')}>Compose</button>
          <button className={crmView === 'pipeline' ? 'btn-gold btn-sm' : 'btn-ghost btn-sm'} onClick={() => setCrmView('pipeline')}>
            Pipeline {contactedFirms.length > 0 && <span style={{ background: 'rgba(200,169,110,.25)', borderRadius: 10, padding: '1px 6px', marginLeft: 4, fontSize: 11 }}>{contactedFirms.length}</span>}
          </button>
        </div>
      </div>

      {/* SENDER BAR */}
      {settOpen ? (
        <div className="card" style={{ padding: '16px 20px', marginBottom: 16 }}>
          <div className="section-head">Your Details</div>
          <div className="form-grid-2" style={{ gap: 10, marginBottom: 12 }}>
            <input placeholder="Your name" value={sN} onChange={e => setSN(e.target.value)} />
            <input placeholder="Your title" value={sT} onChange={e => setST(e.target.value)} />
            <input placeholder="Your firm" value={sF} onChange={e => setSF(e.target.value)} />
            <input placeholder="Your mailing address" value={sA} onChange={e => setSA(e.target.value)} />
          </div>
          <button className="btn-gold btn-sm" onClick={() => setSettOpen(false)}>Done</button>
        </div>
      ) : (
        <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 16, background: 'var(--surface)', border: '1px solid var(--border)', borderRadius: 10, padding: '9px 16px' }}>
          <div style={{ fontSize: 12 }}>
            {sN ? <><span style={{ fontWeight: 600 }}>{sN}</span><span style={{ color: 'var(--text3)' }}> Â· {sT} Â· {sF}</span></> : <span style={{ color: 'var(--text3)' }}>Add your name and title for letters</span>}
          </div>
          <button className="btn-ghost btn-sm" onClick={() => setSettOpen(true)}>Edit Sender</button>
        </div>
      )}

      {/* PIPELINE VIEW */}
      {crmView === 'pipeline' && (
        <div className="fade-in">
          {contactedFirms.length === 0 ? (
            <div style={{ textAlign: 'center', padding: '60px 0', color: 'var(--text3)' }}>
              <div style={{ fontSize: 36, marginBottom: 12, opacity: .3 }}>ðŸ“‹</div>
              <div style={{ fontFamily: 'Instrument Serif,serif', fontSize: 22, color: 'var(--text2)', marginBottom: 8 }}>No active campaigns</div>
              <div style={{ fontSize: 12 }}>Start a campaign from the Compose tab.</div>
            </div>
          ) : (
            <div style={{ display: 'flex', flexDirection: 'column', gap: 10 }}>
              {contactedFirms.map(record => {
                const f = FIRMS.find(x => x.crd === record.crd);
                const seq = CADENCE_SEQUENCES[record.aggressiveness] || [];
                const lastTouch = record.touches[record.touches.length - 1];
                const nextT = seq.find(t => t.touchNum === lastTouch.touchNum + 1);
                const days = daysUntilNext(record);
                const pct = Math.round((record.touches.length / seq.length) * 100);
                const isComplete = record.touches.length >= seq.length;
                return (
                  <div key={record.crd} className="card" style={{ padding: '16px 20px' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                      <div style={{ flex: 1, minWidth: 0 }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 4 }}>
                          <span style={{ fontFamily: 'Instrument Serif,serif', fontSize: 16, cursor: 'pointer', color: 'var(--text)' }}
                            onClick={() => { const firm = FIRMS.find(x => x.crd === record.crd); if (firm) { setFirm(firm); setCrmView('compose'); } }}>
                            {record.firmName}
                          </span>
                          <span className="tag tag-state">{record.firmState}</span>
                          <span className={'tag ' + (record.aggressiveness === 'persistent' ? 'tag-red' : record.aggressiveness === 'active' ? 'tag-amber' : 'tag-dim')}>{AGG_LABELS[record.aggressiveness]}</span>
                          {isComplete && <span className="tag tag-green">Complete</span>}
                        </div>
                        <div style={{ fontSize: 11, color: 'var(--text3)', marginBottom: 10 }}>
                          {record.firmCity}, {record.firmState} Â· {record.purpose} Â· {record.touches.length}/{seq.length} touches sent
                        </div>
                        {/* Progress bar */}
                        <div style={{ height: 4, background: 'var(--surface3)', borderRadius: 3, marginBottom: 10, overflow: 'hidden' }}>
                          <div style={{ height: '100%', width: pct + '%', background: isComplete ? 'var(--green)' : 'var(--accent)', borderRadius: 3, transition: 'width .4s' }} />
                        </div>
                        {/* Touch pills */}
                        <div style={{ display: 'flex', gap: 5, flexWrap: 'wrap', marginBottom: 8 }}>
                          {seq.map(t => {
                            const done = record.touches.find(x => x.touchNum === t.touchNum);
                            const isNext = t.touchNum === lastTouch.touchNum + 1;
                            return (
                              <div key={t.touchNum} title={t.label + (done ? ' - sent ' + new Date(done.sentAt).toLocaleDateString() : '')}
                                style={{
                                  width: 28, height: 28, borderRadius: '50%', display: 'flex', alignItems: 'center', justifyContent: 'center',
                                  fontSize: 12, cursor: isNext ? 'pointer' : 'default',
                                  background: done ? 'var(--green-dim)' : isNext ? 'rgba(200,169,110,.15)' : 'var(--surface2)',
                                  border: '1px solid ' + (done ? 'var(--green)' : isNext ? 'var(--accent)' : 'var(--border)'),
                                  color: done ? 'var(--green)' : isNext ? 'var(--accent)' : 'var(--text3)',
                                }}
                                onClick={() => { if (isNext && !isComplete) { const firm = FIRMS.find(x => x.crd === record.crd); if (firm) { setFirm(firm); setActiveTouchNum(t.touchNum); setCrmView('compose'); }}}}
                              >
                                {done ? 'âœ“' : TYPE_ICON[t.type]}
                              </div>
                            );
                          })}
                        </div>
                        {!isComplete && nextT && days !== null && (
                          <div style={{ fontSize: 11, color: days <= 0 ? 'var(--green)' : 'var(--text3)' }}>
                            {days <= 0
                              ? <span style={{ color: 'var(--green)', fontWeight: 600 }}>Ready: {nextT.label}</span>
                              : <span>Next: {nextT.label} in {days} day{days !== 1 ? 's' : ''}</span>}
                          </div>
                        )}
                      </div>
                      <div style={{ display: 'flex', gap: 6, marginLeft: 16, flexShrink: 0 }}>
                        <button className="btn-ghost btn-sm" onClick={() => { const firm = FIRMS.find(x => x.crd === record.crd); if (firm) { setFirm(firm); setCrmView('compose'); } }}>Open</button>
                        <button className="btn-danger btn-sm" onClick={() => { if (confirm('Remove this campaign?')) removeCampaign(record.crd); }}>âœ•</button>
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>
      )}

      {/* COMPOSE VIEW */}
      {crmView === 'compose' && (
        <div style={{ display: 'grid', gridTemplateColumns: '320px 1fr', gap: 20 }}>
          {/* LEFT COLUMN */}
          <div>
            {/* Firm selector */}
            <div className="card" style={{ padding: '16px 20px', marginBottom: 12 }}>
              <div className="section-head">Recipient Firm</div>
              <select value={firm?.crd || ''} onChange={e => { const f = FIRMS.find(x => x.crd === e.target.value); setFirm(f || null); setPrompt(''); setActiveTouchNum(null); }} style={{ marginBottom: 10 }}>
                <option value="">Choose a firm...</option>
                {FIRMS.slice().sort((a, b) => a.name.localeCompare(b.name)).map(f => <option key={f.crd} value={f.crd}>{f.name} ({f.state}) -- {fmtM(f.aum)}</option>)}
              </select>
              {firm && (
                <div style={{ fontSize: 12, lineHeight: 1.7 }}>
                  <div style={{ fontWeight: 600, marginBottom: 1 }}>{firm.name}</div>
                  <div style={{ color: 'var(--text3)', marginBottom: 6 }}>{firm.city}, {firm.state}</div>
                  <div style={{ fontFamily: 'DM Mono,monospace', fontSize: 11, display: 'flex', gap: 10 }}>
                    <span>{fmtM(firm.aum)}</span>
                    <span style={{ color: 'var(--accent)' }}>{fmtM((firm.aum || 0) * roa)}</span>
                    <span>{fmtN(firm.employees)} emp</span>
                  </div>
                </div>
              )}
            </div>

            {/* Campaign settings â€” locked once campaign started */}
            <div className="card" style={{ padding: '16px 20px', marginBottom: 12 }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 10 }}>
                <div className="section-head" style={{ marginBottom: 0 }}>Campaign Settings</div>
                {firmCrm && <span style={{ fontSize: 10, color: 'var(--green)', fontWeight: 600, textTransform: 'uppercase', letterSpacing: '.05em' }}>Active</span>}
              </div>
              <div style={{ marginBottom: 10 }}>
                <label className="form-field-label">Purpose</label>
                <select value={firmCrm?.purpose || purpose} onChange={e => setP(e.target.value)} disabled={!!firmCrm}>
                  <option value="acquisition">Acquisition / Merger</option>
                  <option value="partnership">Strategic Partnership</option>
                  <option value="recruiting">Recruiting</option>
                  <option value="services">Professional Services</option>
                  <option value="referral">Referral Relationship</option>
                </select>
              </div>
              <div style={{ marginBottom: 10 }}>
                <label className="form-field-label">Aggressiveness</label>
                <div style={{ display: 'flex', flexDirection: 'column', gap: 6 }}>
                  {AGG_OPTS.map(o => (
                    <div key={o.v}
                      onClick={() => !firmCrm && setAgg(o.v)}
                      style={{
                        padding: '8px 12px', borderRadius: 8, border: '1px solid',
                        borderColor: (firmCrm?.aggressiveness || aggressiveness) === o.v ? 'var(--accent)' : 'var(--border)',
                        background: (firmCrm?.aggressiveness || aggressiveness) === o.v ? 'rgba(200,169,110,.08)' : 'transparent',
                        cursor: firmCrm ? 'default' : 'pointer', transition: 'all .15s',
                      }}>
                      <div style={{ fontSize: 12, fontWeight: 600, color: (firmCrm?.aggressiveness || aggressiveness) === o.v ? 'var(--accent)' : 'var(--text2)' }}>{o.label}</div>
                      <div style={{ fontSize: 11, color: 'var(--text3)' }}>{o.desc}</div>
                    </div>
                  ))}
                </div>
              </div>
              <div>
                <label className="form-field-label">Context / Notes</label>
                <textarea rows={2} value={ctx} onChange={e => setCtx(e.target.value)} style={{ resize: 'vertical', fontSize: 12 }} placeholder="Shared connection, specific angle..." />
              </div>
              {firm && !firmCrm && (
                <button className="btn-gold" style={{ width: '100%', marginTop: 10 }} onClick={initCampaign}>Start Campaign</button>
              )}
            </div>

            {/* Sequence timeline */}
            {firm && firmCrm && (
              <div className="card" style={{ padding: '16px 20px' }}>
                <div className="section-head">Sequence</div>
                <div style={{ display: 'flex', flexDirection: 'column', gap: 2 }}>
                  {sequence.map((t, i) => {
                    const done = sentTouches.find(x => x.touchNum === t.touchNum);
                    const isNext = t.touchNum === nextTouchNum;
                    const isActive = t.touchNum === activeTouchNum;
                    return (
                      <div key={t.touchNum}
                        onClick={() => t.type !== 'pause' && setActiveTouchNum(isActive ? null : t.touchNum)}
                        style={{
                          display: 'flex', alignItems: 'center', gap: 10, padding: '7px 10px', borderRadius: 8,
                          cursor: t.type !== 'pause' ? 'pointer' : 'default',
                          background: isActive ? 'rgba(200,169,110,.08)' : 'transparent',
                          border: '1px solid ' + (isActive ? 'var(--accent)' : 'transparent'),
                          transition: 'all .15s',
                        }}>
                        <div style={{
                          width: 26, height: 26, borderRadius: '50%', display: 'flex', alignItems: 'center', justifyContent: 'center',
                          fontSize: 11, flexShrink: 0,
                          background: done ? 'var(--green-dim)' : isNext ? 'rgba(200,169,110,.15)' : 'var(--surface3)',
                          border: '1px solid ' + (done ? 'var(--green)' : isNext ? 'var(--accent)' : 'var(--border)'),
                          color: done ? 'var(--green)' : isNext ? 'var(--accent)' : 'var(--text3)',
                        }}>
                          {done ? 'âœ“' : TYPE_ICON[t.type]}
                        </div>
                        <div style={{ flex: 1, minWidth: 0 }}>
                          <div style={{ fontSize: 12, fontWeight: isNext ? 600 : 400, color: done ? 'var(--text3)' : isNext ? 'var(--text)' : 'var(--text2)', textDecoration: done ? 'line-through' : 'none' }}>
                            {t.label}
                          </div>
                          {done && <div style={{ fontSize: 10, color: 'var(--text3)' }}>Sent {new Date(done.sentAt).toLocaleDateString()}</div>}
                          {isNext && !done && <div style={{ fontSize: 10, color: 'var(--accent)' }}>Up next</div>}
                          {t.daysAfterPrev > 0 && !done && !isNext && i > 0 && <div style={{ fontSize: 10, color: 'var(--text3)' }}>{t.daysAfterPrev}d after prev</div>}
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            )}
          </div>

          {/* RIGHT COLUMN */}
          <div>
            {!firm && (
              <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', height: '100%', minHeight: 400, color: 'var(--text3)' }}>
                <div style={{ fontSize: 42, opacity: .3, marginBottom: 12 }}>âœ‰</div>
                <div style={{ fontFamily: 'Instrument Serif,serif', fontSize: 22, color: 'var(--text2)', marginBottom: 6 }}>Select a firm to begin</div>
                <div style={{ fontSize: 12, maxWidth: 260, textAlign: 'center', lineHeight: 1.7 }}>Choose a firm on the left, set your campaign settings, and generate touch prompts.</div>
              </div>
            )}

            {firm && !firmCrm && (
              <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', height: '100%', minHeight: 400, color: 'var(--text3)' }}>
                <div style={{ fontSize: 42, opacity: .3, marginBottom: 12 }}>ðŸš€</div>
                <div style={{ fontFamily: 'Instrument Serif,serif', fontSize: 22, color: 'var(--text2)', marginBottom: 6 }}>Ready to start</div>
                <div style={{ fontSize: 12, maxWidth: 300, textAlign: 'center', lineHeight: 1.7, marginBottom: 20 }}>Configure your purpose and aggressiveness, then click Start Campaign to begin the outreach sequence.</div>
                <button className="btn-gold" onClick={initCampaign}>Start Campaign for {firm.name} â†’</button>
              </div>
            )}

            {firm && firmCrm && (
              <div className="fade-in">
                {/* Active touch card */}
                {activeTouch && (
                  <div style={{ marginBottom: 16 }}>
                    <div className="card" style={{ padding: '18px 20px', borderColor: activeTouch.type !== 'pause' ? 'rgba(200,169,110,.3)' : 'var(--border)' }}>
                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: 12 }}>
                        <div>
                          <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 4 }}>
                            <span style={{ fontSize: 18 }}>{TYPE_ICON[activeTouch.type]}</span>
                            <span style={{ fontFamily: 'Instrument Serif,serif', fontSize: 20 }}>Touch #{activeTouch.touchNum}: {activeTouch.label}</span>
                          </div>
                          <div style={{ fontSize: 12, color: 'var(--text3)', lineHeight: 1.6, maxWidth: 500 }}>{activeTouch.desc}</div>
                        </div>
                        <div style={{ display: 'flex', gap: 6, flexShrink: 0 }}>
                          {activeTouch.type !== 'pause' && (
                            <button className="btn-gold btn-sm" onClick={() => generatePrompt(activeTouch)}>Generate Prompt</button>
                          )}
                          {activeTouch.touchNum === nextTouchNum && activeTouch.type !== 'pause' && (
                            <button className="btn-ghost btn-sm" style={{ color: 'var(--green)', borderColor: 'rgba(74,222,128,.3)' }} onClick={() => setShowLogModal(true)}>
                              Mark Sent âœ“
                            </button>
                          )}
                        </div>
                      </div>
                      {activeTouch.type === 'pause' && (
                        <div style={{ background: 'var(--surface2)', borderRadius: 8, padding: '10px 14px', fontSize: 12, color: 'var(--text3)' }}>
                          This is a planned quiet period. No outreach during this window. Click Mark Sent to log the pause and advance the sequence.
                          <button className="btn-ghost btn-sm" style={{ marginLeft: 12 }} onClick={() => setShowLogModal(true)}>Log Pause</button>
                        </div>
                      )}
                    </div>
                  </div>
                )}

                {/* Prompt output */}
                {prompt && (
                  <div className="fade-in">
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 10 }}>
                      <div style={{ fontSize: 13, fontWeight: 600 }}>Prompt Ready</div>
                      <div style={{ display: 'flex', gap: 8 }}>
                        <button className={'btn-gold btn-sm' + (copied ? ' copy-flash' : '')}
                          onClick={() => { navigator.clipboard.writeText(prompt); setCopied(true); setTimeout(() => setCopied(false), 2000); }}>
                          {copied ? 'âœ“ Copied' : 'Copy to Clipboard'}
                        </button>
                        <button className="btn-ghost btn-sm" style={{ color: 'var(--green)', borderColor: 'rgba(74,222,128,.3)' }} onClick={() => setShowLogModal(true)}>
                          Mark Sent âœ“
                        </button>
                      </div>
                    </div>
                    <div style={{ fontSize: 12, color: 'var(--text3)', marginBottom: 10 }}>
                      Paste into <a href="https://claude.ai" target="_blank" rel="noopener" style={{ color: 'var(--accent)' }}>Claude</a> or any AI to generate the {activeTouch?.type}.
                    </div>
                    <div className="card" style={{ padding: 20, maxHeight: 'calc(100vh - 380px)', overflow: 'auto' }}>
                      <pre className="prompt-box">{prompt}</pre>
                    </div>
                  </div>
                )}

                {!prompt && !activeTouch && (
                  <div style={{ textAlign: 'center', padding: '60px 0', color: 'var(--text3)' }}>
                    <div style={{ fontSize: 12 }}>Select a touch from the sequence to generate its prompt.</div>
                  </div>
                )}
              </div>
            )}
          </div>
        </div>
      )}

      {/* LOG SENT MODAL */}
      {showLogModal && (
        <div className="modal-overlay" onClick={e => e.target === e.currentTarget && setShowLogModal(false)}>
          <div className="modal slide-down" style={{ maxWidth: 420 }}>
            <div className="modal-header">
              <div className="modal-title" style={{ fontSize: 20 }}>Log Touch #{activeTouch?.touchNum}</div>
              <div style={{ fontSize: 13, color: 'var(--text3)', marginTop: 4, marginBottom: 16 }}>{activeTouch?.label} -- {firm?.name}</div>
            </div>
            <div className="modal-body">
              <div style={{ marginBottom: 16 }}>
                <label className="form-field-label">Notes (optional)</label>
                <textarea rows={3} value={logNotes} onChange={e => setLogNotes(e.target.value)}
                  style={{ resize: 'vertical' }} placeholder="Any context, response received, follow-up flags..." />
              </div>
              <div style={{ display: 'flex', justifyContent: 'space-between', paddingTop: 16, borderTop: '1px solid var(--border)' }}>
                <button className="btn-ghost" onClick={() => setShowLogModal(false)}>Cancel</button>
                <button className="btn-gold" onClick={logTouch}>Confirm Sent -- Advance Sequence</button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// =============================================================================
// SAVED TARGETS
// =============================================================================
function SavedTargets({ saved, setSaved, notes, setNotes, roa, onSelect, onLetter, profile, onOpenOnboarding }) {
  const hasProfile = !!profile;
  const firms = useMemo(() => FIRMS.filter(f => saved.has(f.crd)).sort((a, b) => a.name.localeCompare(b.name)), [saved]);
  const totAum = firms.reduce((s, f) => s + (f.aum || 0), 0), totRev = totAum * roa;
  const [editCrd, setEditCrd] = useState(null);
  const [editText, setEditText] = useState('');
  const startEdit = crd => { setEditCrd(crd); setEditText(notes[crd] || ''); };
  const saveNote = crd => { const n = { ...notes }; if (editText.trim()) n[crd] = editText.trim(); else delete n[crd]; setNotes(n); saveNotes(n); setEditCrd(null); };
  const remove = crd => { const s = new Set(saved); s.delete(crd); setSaved(s); saveSaved(s); const n = { ...notes }; delete n[crd]; setNotes(n); saveNotes(n); };
  const exportCSV = () => {
    const hdr = ['Name', 'CRD', 'State', 'City', 'Address', 'Zip', 'Phone', 'Website', 'RAUM', 'Est Revenue', 'Accounts', 'Employees', 'Ind Clients', 'HNW Clients', 'Services', 'Compensation', 'Notes'];
    const rows = firms.map(f => [f.name, f.crd, f.state, f.city, f.addr1 + (f.addr2 ? ', ' + f.addr2 : ''), f.zip, f.phone, f.website, f.aum || 0, Math.round((f.aum || 0) * roa), f.accounts || '', f.employees || '', f.clientsInd || '', f.clientsHNW || '', '"' + f.services.join('; ') + '"', '"' + f.compensation.join('; ') + '"', '"' + (notes[f.crd] || '').replace(/"/g, '""') + '"']);
    const csv = [hdr.join(','), ...rows.map(r => r.join(','))].join('\n');
    const blob = new Blob([csv], { type: 'text/csv' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'ria_targets_' + new Date().toISOString().slice(0, 10) + '.csv'; a.click();
  };

  if (!hasProfile) return (
    <div className="page" style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', minHeight: '60vh' }}>
      <GateBanner onOpenOnboarding={onOpenOnboarding} />
    </div>
  );

  if (!firms.length) return (
    <div className="page" style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', minHeight: '60vh' }}>
      <div style={{ fontSize: 48, marginBottom: 16, opacity: .3 }}>â˜†</div>
      <div style={{ fontFamily: 'Instrument Serif,serif', fontSize: 28, marginBottom: 10, color: 'var(--text2)' }}>No saved targets yet</div>
      <div style={{ fontSize: 13, color: 'var(--text3)', maxWidth: 340, textAlign: 'center', lineHeight: 1.7 }}>Use â˜… to save firms across the platform. They persist across sessions.</div>
    </div>
  );

  return (
    <div className="page fade-up">
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-end', marginBottom: 24 }}>
        <div>
          <div className="page-title">{firms.length} Saved Target{firms.length !== 1 ? 's' : ''}</div>
          <div className="page-sub" style={{ fontFamily: 'DM Mono,monospace', fontSize: 12 }}>RAUM {fmtM(totAum)} Â· Est Rev {fmtM(totRev)}</div>
        </div>
        <div style={{ display: 'flex', gap: 8 }}>
          <button className="btn-gold btn-sm" onClick={exportCSV}>â†“ Export CSV</button>
          <button className="btn-danger btn-sm" onClick={() => { if (confirm('Clear all saved targets?')) { setSaved(new Set()); setNotes({}); saveSaved(new Set()); saveNotes({}); } }}>Clear all</button>
        </div>
      </div>
      <div style={{ display: 'flex', flexDirection: 'column', gap: 10 }}>
        {firms.map(f => {
          const rev = (f.aum || 0) * roa, wurl = wu(f.website);
          return (
            <div key={f.crd} className="saved-card">
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                <div style={{ flex: 1, minWidth: 0 }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 6 }}>
                    <span style={{ fontFamily: 'Instrument Serif,serif', fontSize: 18, cursor: 'pointer' }} onClick={() => onSelect(f)}>{f.name}</span>
                    <span className="tag tag-state">{f.state}</span>
                  </div>
                  <div style={{ fontSize: 11, color: 'var(--text3)', marginBottom: 10 }}>{f.city}, {f.state} {f.zip}{f.phone && <span> Â· {f.phone}</span>}{wurl && <span> Â· <a href={wurl} target="_blank" rel="noopener" style={{ color: 'var(--accent)' }}>Website â†—</a></span>}</div>
                  <div style={{ display: 'flex', gap: 20, fontFamily: 'DM Mono,monospace', fontSize: 12 }}>
                    <span>RAUM <b>{fmtM(f.aum)}</b></span>
                    <span style={{ color: 'var(--accent)' }}>Rev <b>{fmtM(rev)}</b></span>
                    <span>Accts <b>{fmtN(f.accounts)}</b></span>
                    <span>Emp <b>{fmtN(f.employees)}</b></span>
                    <span>HNW <b>{fmtN(f.clientsHNW)}</b></span>
                  </div>
                  {editCrd === f.crd
                    ? <div style={{ marginTop: 12, display: 'flex', gap: 8 }}><textarea value={editText} onChange={e => setEditText(e.target.value)} rows={2} style={{ flex: 1, resize: 'vertical', fontSize: 12 }} /><button className="btn-gold btn-sm" onClick={() => saveNote(f.crd)}>Save</button><button className="btn-ghost btn-sm" onClick={() => setEditCrd(null)}>Cancel</button></div>
                    : notes[f.crd] && <div style={{ marginTop: 10, fontSize: 12, color: 'var(--text2)', background: 'var(--surface2)', padding: '8px 14px', borderRadius: 8, borderLeft: '2px solid var(--accent)', cursor: 'pointer' }} onClick={() => startEdit(f.crd)}>{notes[f.crd]}</div>
                  }
                </div>
                <div style={{ display: 'flex', gap: 6, marginLeft: 16, flexShrink: 0 }}>
                  <button className="btn-ghost btn-sm btn-icon" onClick={() => startEdit(f.crd)}>âœŽ</button>
                  <button className="btn-ghost btn-sm" onClick={() => onSelect(f)}>View</button>
                  <button className="btn-ghost btn-sm" onClick={() => onLetter(f)}>âœ‰</button>
                  <button className="btn-danger btn-sm" onClick={() => remove(f.crd)}>âœ•</button>
                </div>
              </div>
            </div>
          );
        })}
      </div>
    </div>
  );
}

// =============================================================================
// APP ROOT
// =============================================================================
// APP ROOT
// =============================================================================
function App() {
  const [view, setView]       = useState('dashboard');
  const [firm, setFirm]       = useState(null);
  const [roa, setRoa]         = useState(0.0065);
  const [profile, setProfile] = useState(() => loadProfile());
  const [showOnboarding, setShowOnboarding] = useState(false);
  const [saved, setSaved]     = useState(() => loadSaved());
  const [notes, setNotes]     = useState(() => loadNotes());
  const [crm, setCrm]         = useState(() => loadCRM());
  const setCrmAndSave = (c) => { setCrm(c); saveCRM(c); };

  const hasProfile = !!profile;

  const toggleSave = crd => {
    const s = new Set(saved);
    if (s.has(crd)) s.delete(crd); else s.add(crd);
    setSaved(s); saveSaved(s);
  };

  const handleProfileComplete = p => {
    setProfile(p);
    setShowOnboarding(false);
    setView('myprofile');
  };

  const handleClearProfile = () => {
    clearProfile();
    setProfile(null);
    setView('dashboard');
  };

  const sel = f => { setFirm(f); setView('detail'); };
  const wl  = f => { setFirm(f); setView('letter'); };
  const openOnboarding = () => setShowOnboarding(true);

  // Full-screen onboarding takes over when shown
  if (showOnboarding) {
    return (
      <OnboardingModal
        onComplete={handleProfileComplete}
        onClose={hasProfile ? () => setShowOnboarding(false) : null}
      />
    );
  }

  return (
    <div style={{ minHeight: '100vh', display: 'flex', flexDirection: 'column' }}>
      <Nav view={view} setView={setView} savedCount={saved.size} profile={profile} onOpenOnboarding={openOnboarding} />
      <div style={{ flex: 1, overflow: 'auto' }}>
        {view === 'dashboard'  && <Dashboard roa={roa} onSelect={sel} saved={saved} toggleSave={toggleSave} profile={profile} onOpenOnboarding={openOnboarding} />}
        {view === 'explorer'   && <Explorer roa={roa} setRoa={setRoa} onSelect={sel} saved={saved} toggleSave={toggleSave} profile={profile} onOpenOnboarding={openOnboarding} />}
        {view === 'detail'     && <FirmDetail firm={firm} setFirm={setFirm} onLetter={wl} roa={roa} saved={saved} toggleSave={toggleSave} profile={profile} onOpenOnboarding={openOnboarding} />}
        {view === 'letter'     && <LetterWriter firm={firm} setFirm={setFirm} roa={roa} profile={profile} onOpenOnboarding={openOnboarding} crm={crm} setCrmAndSave={setCrmAndSave} />}
        {view === 'saved'      && <SavedTargets saved={saved} setSaved={setSaved} notes={notes} setNotes={setNotes} roa={roa} onSelect={sel} onLetter={wl} profile={profile} onOpenOnboarding={openOnboarding} />}
        {view === 'myprofile'  && <MyProfile profile={profile} roa={roa} onOpenOnboarding={openOnboarding} onClearProfile={handleClearProfile} onSelect={sel} />}
      </div>
    </div>
  );
}

ReactDOM.render(<App />, document.getElementById('root'));
</script>
</body>
</html>
